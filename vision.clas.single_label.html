<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Single Label Classification with Computer Vision (Beginner)</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Welcome to fastai">
    
    <link rel="preload" href="/walkwithfastai.github.io/assets/css/0.styles.57b101cf.css" as="style"><link rel="preload" href="/walkwithfastai.github.io/assets/js/app.d213da4d.js" as="script"><link rel="preload" href="/walkwithfastai.github.io/assets/js/2.3552a41d.js" as="script"><link rel="preload" href="/walkwithfastai.github.io/assets/js/15.96fcd54f.js" as="script"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/10.1c53449a.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/11.f91edc13.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/12.c9267090.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/13.905833e1.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/14.71aae364.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/16.60f565fe.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/17.6360a1cb.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/3.fb63bfb9.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/4.b52d6096.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/5.1a7d8c98.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/6.86aec1e1.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/7.9883384d.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/8.4b03437f.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/9.0fe2b969.js">
    <link rel="stylesheet" href="/walkwithfastai.github.io/assets/css/0.styles.57b101cf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/walkwithfastai.github.io/" class="home-link router-link-active"><img src="https://www.jovian.ml/fastai_logo.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/walkwithfastai.github.io/" class="nav-link">
  Overview
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Introduction" class="dropdown-title"><span class="title">Introduction</span> <span class="arrow down"></span></button> <button type="button" aria-label="Introduction" class="mobile-dropdown-title"><span class="title">Introduction</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/intro.contribute.html" class="nav-link">
  How to Contribute a Chapter
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vision" class="dropdown-title"><span class="title">Vision</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vision" class="mobile-dropdown-title"><span class="title">Vision</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/vision.intro.html" class="nav-link">
  Introduction
</a></li><li class="dropdown-item"><h4>
          Classification
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/vision.clas.single_label.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Single Label (Beginner)
</a></li></ul></li><li class="dropdown-item"><h4>
          External Model Integrations
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/vision.external.timm.html" class="nav-link">
  timm
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tabular" class="dropdown-title"><span class="title">Tabular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tabular" class="mobile-dropdown-title"><span class="title">Tabular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/tab.clas.binary.html" class="nav-link">
  Introduction
</a></li><li class="dropdown-item"><h4>
          Classification
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/tab.clas.binary.html" class="nav-link">
  Binary (Beginner)
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/tab.cv.html" class="nav-link">
  Cross Validation (Intermediate)
</a></li></ul></div></div> <a href="https://github.com/walkwithfastai/walkwithfastai.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/walkwithfastai.github.io/" class="nav-link">
  Overview
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Introduction" class="dropdown-title"><span class="title">Introduction</span> <span class="arrow down"></span></button> <button type="button" aria-label="Introduction" class="mobile-dropdown-title"><span class="title">Introduction</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/intro.contribute.html" class="nav-link">
  How to Contribute a Chapter
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vision" class="dropdown-title"><span class="title">Vision</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vision" class="mobile-dropdown-title"><span class="title">Vision</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/vision.intro.html" class="nav-link">
  Introduction
</a></li><li class="dropdown-item"><h4>
          Classification
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/vision.clas.single_label.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Single Label (Beginner)
</a></li></ul></li><li class="dropdown-item"><h4>
          External Model Integrations
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/vision.external.timm.html" class="nav-link">
  timm
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tabular" class="dropdown-title"><span class="title">Tabular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tabular" class="mobile-dropdown-title"><span class="title">Tabular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/tab.clas.binary.html" class="nav-link">
  Introduction
</a></li><li class="dropdown-item"><h4>
          Classification
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/tab.clas.binary.html" class="nav-link">
  Binary (Beginner)
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/tab.cv.html" class="nav-link">
  Cross Validation (Intermediate)
</a></li></ul></div></div> <a href="https://github.com/walkwithfastai/walkwithfastai.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Single Label Classification with Computer Vision (Beginner)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/walkwithfastai.github.io/vision.clas.single_label.html#introduction" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/walkwithfastai.github.io/vision.clas.single_label.html#importing-the-library-and-the-dataset" class="sidebar-link">Importing the Library and the Dataset</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/walkwithfastai.github.io/vision.clas.single_label.html#building-the-dataloaders" class="sidebar-link">Building the DataLoaders</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/walkwithfastai.github.io/vision.clas.single_label.html#looking-at-the-data" class="sidebar-link">Looking at the Data</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/walkwithfastai.github.io/vision.clas.single_label.html#time-to-make-and-train-a-model" class="sidebar-link">Time To Make and Train a Model!</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="single-label-classification-with-computer-vision-beginner"><a href="#single-label-classification-with-computer-vision-beginner" class="header-anchor">#</a> Single Label Classification with Computer Vision (Beginner)</h1> <blockquote><p>Covering how to perform single-label classification with the PETs dataset</p></blockquote> <hr> <p>This article is also a Jupyter Notebook available to be run from the top down. There will be code snippets that you can then run in any environment. Below are the versions of <code>fastai</code> and <code>fastcore</code> currently running at the time of writing this:</p> <ul><li><code>fastai</code>: 2.0.14</li> <li><code>fastcore</code>: 1.0.11</li></ul> <hr> <h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p>This tutorial will cover single-label classification inside of the <code>fastai</code> library. It will closely follow the lesson 1 notebook from <a href="https://github.com/muellerzr/Practical-Deep-Learning-for-Coders-2.0/blob/master/Computer%20Vision/01_Pets.ipynb" target="_blank" rel="noopener noreferrer">A walk with fastai2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and if you wish to watch the lecture video it is available <a href="https://www.youtube.com/watch?v=bw4PRyxa-y4&amp;list=PLFDkaGxp5BXDvj3oHoKDgEcH73Aze-eET&amp;index=1&amp;t=4340s" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="importing-the-library-and-the-dataset"><a href="#importing-the-library-and-the-dataset" class="header-anchor">#</a> Importing the Library and the Dataset</h2> <p>First we need to import <code>fastai</code>'s <code>vision</code> module:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> fastai<span class="token punctuation">.</span>vision<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">import</span> <span class="token operator">*</span>
</code></pre></div><p>The <code>PETs</code> dataset is designed to try and distinguish between 12 species of cats and 25 species of dogs (37 in total). Five years ago the best accuracy was 59% with seperate classifications for parts of the images cropped to related body parts (the head, body, and overall image). Today's neural networks can perform much better on a task such as this, so we will try to achieve a better result using only the one image.</p> <p>But before anything, we need data!</p> <p>To do so we will use the <a href="https://docs.fast.ai/data.external#untar_data" target="_blank" rel="noopener noreferrer"><code>untar_data</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> function paired with <a href="https://docs.fast.ai/data.external#URLs.PETS" target="_blank" rel="noopener noreferrer"><code>URLs.PETS</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. This will go ahead and download and extract a <code>.gz</code> dataset for us. The <a href="https://docs.fast.ai/data.external#URLs.PETS" target="_blank" rel="noopener noreferrer"><code>URLs.PETS</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> denotes the URL where our dataset lives.</p> <p>We can view the documentation for <a href="https://docs.fast.ai/data.external#untar_data" target="_blank" rel="noopener noreferrer"><code>untar_data</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> by using the <code>help</code> or <a href="https://nbdev.fast.ai/showdoc#doc" target="_blank" rel="noopener noreferrer"><code>doc</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> functions:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token builtin">help</span><span class="token punctuation">(</span>untar_data<span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>Help on function untar_data in module fastai.data.external:

untar_data(url, fname=None, dest=None, c_key='data', force_download=False, extract_func=&lt;function file_extract at 0x7fe4f0427050&gt;)
    Download `url` to `fname` if `dest` doesn't exist, and un-tgz or unzip to folder `dest`.
</code></pre></div><p><a href="https://nbdev.fast.ai/showdoc#doc" target="_blank" rel="noopener noreferrer"><code>doc</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> will pull it up in a pop-up window (run this notebook to see):</p> <div class="language-python extra-class"><pre class="language-python"><code>doc<span class="token punctuation">(</span>untar_data<span class="token punctuation">)</span>
</code></pre></div><p>Along with this if we want to explore the source code for any function, put two <code>??</code> after the name of the function and a popup window will appear with the source code!</p> <div class="language-python extra-class"><pre class="language-python"><code>untar_data??
</code></pre></div><p>Now let's download our dataset:</p> <div class="language-python extra-class"><pre class="language-python"><code>path <span class="token operator">=</span> untar_data<span class="token punctuation">(</span>URLs<span class="token punctuation">.</span>PETS<span class="token punctuation">)</span>
</code></pre></div><p>We can see the location of where our data was stored by checking what <code>path</code> contains:</p> <div class="language-python extra-class"><pre class="language-python"><code>path
</code></pre></div><div class="language- extra-class"><pre><code>Path('/home/ml1/.fastai/data/oxford-iiit-pet')
</code></pre></div><p>To make this notebook reproduceable, we can use <code>fastai</code>'s <a href="https://docs.fast.ai/torch_core#set_seed" target="_blank" rel="noopener noreferrer"><code>set_seed</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> function to ensure every possible source of randomness has the same seed:</p> <div class="language-python extra-class"><pre class="language-python"><code>set_seed<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
</code></pre></div><p>Now let's look at hour our data was stored:</p> <div class="language-python extra-class"><pre class="language-python"><code>path<span class="token punctuation">.</span>ls<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>
</code></pre></div><div class="language- extra-class"><pre><code>(#2) [Path('/home/ml1/.fastai/data/oxford-iiit-pet/annotations'),Path('/home/ml1/.fastai/data/oxford-iiit-pet/images')]
</code></pre></div><p>We can see a <code>images</code> and <code>annotations</code> folder. We'll focus on the <code>images</code> folder.</p> <h2 id="building-the-dataloaders"><a href="#building-the-dataloaders" class="header-anchor">#</a> Building the <a href="https://docs.fast.ai/data.core#DataLoaders" target="_blank" rel="noopener noreferrer"><code>DataLoaders</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <p>To actually train our neural network model we need to first prepare our dataset for <code>fastai</code> to expect it. This comes in the form of <a href="https://docs.fast.ai/data.core#DataLoaders" target="_blank" rel="noopener noreferrer"><code>DataLoaders</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. We'll show a high-level one-liner usage followed by a <a href="https://docs.fast.ai/data.block#DataBlock" target="_blank" rel="noopener noreferrer"><code>DataBlock</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> example</p> <p>Since we have the <code>path</code> to our data, we'll need to extract the filenames of all the images.</p> <p><a href="https://docs.fast.ai/data.transforms#get_image_files" target="_blank" rel="noopener noreferrer"><code>get_image_files</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> can do this for us, we simply pass in our <code>path</code> to where the images are stored:</p> <div class="language-python extra-class"><pre class="language-python"><code>fnames <span class="token operator">=</span> get_image_files<span class="token punctuation">(</span>path<span class="token operator">/</span><span class="token string">'images'</span><span class="token punctuation">)</span>
</code></pre></div><p>Now if we look at a filename, we will see that the filename itself contains our class label. We can use a Regular Expression to extract it.</p> <blockquote><p>Do note:throughout this resource you will find multiple ways of completing the same task, so you do not have to follow this example to the letter</p></blockquote> <div class="language-python extra-class"><pre class="language-python"><code>pat <span class="token operator">=</span> <span class="token string">r'/([^/]+)_\d+.*'</span>
</code></pre></div><p>With our pattern that can extract our label, let's move onto some basic transforms:</p> <div class="language-python extra-class"><pre class="language-python"><code>item_tfms <span class="token operator">=</span> RandomResizedCrop<span class="token punctuation">(</span><span class="token number">460</span><span class="token punctuation">,</span> min_scale<span class="token operator">=</span><span class="token number">0.75</span><span class="token punctuation">,</span> ratio<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
batch_tfms <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">*</span>aug_transforms<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">224</span><span class="token punctuation">,</span> max_warp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Normalize<span class="token punctuation">.</span>from_stats<span class="token punctuation">(</span><span class="token operator">*</span>imagenet_stats<span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><blockquote><p>We intend to use a pretrained model for our task, so we need to normalize our data by the original model's data's statistics</p></blockquote> <p>Along with how many images we want our model to process at one time (a batch size):</p> <div class="language-python extra-class"><pre class="language-python"><code>bs<span class="token operator">=</span><span class="token number">64</span>
</code></pre></div><p>Lastly we can build our <a href="https://docs.fast.ai/data.core#DataLoaders" target="_blank" rel="noopener noreferrer"><code>DataLoaders</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>! Let's see a one-liner where we pass it all in</p> <blockquote><p>For those familiar with <code>fastai</code> v1, this is akin to <code>ImageDataBunch</code></p></blockquote> <div class="language-python extra-class"><pre class="language-python"><code>dls <span class="token operator">=</span> ImageDataLoaders<span class="token punctuation">.</span>from_name_re<span class="token punctuation">(</span>path<span class="token punctuation">,</span> fnames<span class="token punctuation">,</span> pat<span class="token punctuation">,</span> 
                                   batch_tfms<span class="token operator">=</span>batch_tfms<span class="token punctuation">,</span>
                                   item_tfms<span class="token operator">=</span>item_tfms<span class="token punctuation">,</span> bs<span class="token operator">=</span>bs<span class="token punctuation">)</span>
</code></pre></div><p>What about using the <a href="https://docs.fast.ai/data.block#DataBlock" target="_blank" rel="noopener noreferrer"><code>DataBlock</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> API I keep hearing about?</p> <p>It's a way to formulate a <em>blueprint</em> of a data pipeline that can be tweaked more than the factory <code>xDataLoaders</code> methods. The version for our problem looks like:</p> <div class="language-python extra-class"><pre class="language-python"><code>pets <span class="token operator">=</span> DataBlock<span class="token punctuation">(</span>blocks<span class="token operator">=</span><span class="token punctuation">(</span>ImageBlock<span class="token punctuation">,</span> CategoryBlock<span class="token punctuation">)</span><span class="token punctuation">,</span>
                 get_items<span class="token operator">=</span>get_image_files<span class="token punctuation">,</span>
                 splitter<span class="token operator">=</span>RandomSplitter<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 get_y<span class="token operator">=</span>RegexLabeller<span class="token punctuation">(</span>pat <span class="token operator">=</span> pat<span class="token punctuation">)</span><span class="token punctuation">,</span>
                 item_tfms<span class="token operator">=</span>item_tfms<span class="token punctuation">,</span>
                 batch_tfms<span class="token operator">=</span>batch_tfms<span class="token punctuation">)</span>
</code></pre></div><p>Let's break it all down:</p> <ul><li><code>blocks</code>:
<ul><li><a href="https://docs.fast.ai/vision.data#ImageBlock" target="_blank" rel="noopener noreferrer"><code>ImageBlock</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: Our <code>x</code>'s will be images</li> <li><a href="https://docs.fast.ai/data.block#CategoryBlock" target="_blank" rel="noopener noreferrer"><code>CategoryBlock</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: Our <code>y</code>s will be a single category label</li></ul></li> <li><code>get_items</code>: How we are getting our data. (when doing image problems you will mostly just use <a href="https://docs.fast.ai/data.transforms#get_image_files" target="_blank" rel="noopener noreferrer"><code>get_image_files</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> by default)</li> <li><code>splitter</code>: How we want to split our data.
<ul><li><a href="https://docs.fast.ai/data.transforms#RandomSplitter" target="_blank" rel="noopener noreferrer"><code>RandomSplitter</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: Will randomly split the data with 20% in our validation set (by default), with the other 80% in our training data. We can pass in a percentage and a seed. (we won't be doing the latter as we already set a global seed)</li></ul></li> <li><code>get_y</code>: How to extract the labels for our data
<ul><li><a href="https://docs.fast.ai/data.transforms#RegexLabeller" target="_blank" rel="noopener noreferrer"><code>RegexLabeller</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: Uses a Regex <code>pat</code> to extract them</li></ul></li> <li><code>item</code> and <code>batch</code> tfms are our data augmentation</li></ul> <p>So now that we have the blueprint we can build our <a href="https://docs.fast.ai/data.core#DataLoaders" target="_blank" rel="noopener noreferrer"><code>DataLoaders</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> by calling the <code>.dataloaders</code> method. We'll need to pass it a location to find our source images as well as that batch size we defined earlier:</p> <div class="language-python extra-class"><pre class="language-python"><code>path_im <span class="token operator">=</span> path<span class="token operator">/</span><span class="token string">'images'</span>
dls <span class="token operator">=</span> pets<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>path_im<span class="token punctuation">,</span> bs<span class="token operator">=</span>bs<span class="token punctuation">)</span>
</code></pre></div><h2 id="looking-at-the-data"><a href="#looking-at-the-data" class="header-anchor">#</a> Looking at the Data</h2> <p>Now that the <a href="https://docs.fast.ai/data.core#DataLoaders" target="_blank" rel="noopener noreferrer"><code>DataLoaders</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> have been built we can take a peek at the data and a few special bits and pieces about them.</p> <p>First let's take a look at a batch of data. We can use the <code>show_batch</code> function and pass in a maximum number of images to show, as well as how large we want them to appear as in our notebooks.</p> <blockquote><p>By default it will show images from the validation <a href="https://docs.fast.ai/data.load#DataLoader" target="_blank" rel="noopener noreferrer"><code>DataLoader</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. To show data from the training set, use <code>dls[0]</code> rather than <code>dls</code></p></blockquote> <div class="language-python extra-class"><pre class="language-python"><code>dls<span class="token punctuation">.</span>show_batch<span class="token punctuation">(</span>max_n<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">,</span> figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p><img src="output_38_0.png" alt="png"></p> <p>If we want to see how many classes we have, and the names of them we can simply call <code>dls.vocab</code>. The first is the number of classes, the second is the names of our classes. You may notice this looks a bit odd, that's because this <a href="https://fastcore.fast.ai/foundation#L" target="_blank" rel="noopener noreferrer"><code>L</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is a new invention of Jeremy and Sylvian. Essentially it's a Python list taken to the extreme.</p> <p>Before if we wanted to grab the index for the name of a class (eg. our model output 0 as our class), we would need to use <code>data.c2i</code> to grab the Class2Index mapping. This is still here, it lives in <code>dls.vocab.o2i</code> (Object2ID).</p> <p>It's a dictionary mapping of <code>name -&gt; value</code>, so let's only look at the first five (since we have 37 in total!)</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token punctuation">{</span>k<span class="token punctuation">:</span> dls<span class="token punctuation">.</span>vocab<span class="token punctuation">.</span>o2i<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">list</span><span class="token punctuation">(</span>dls<span class="token punctuation">.</span>vocab<span class="token punctuation">.</span>o2i<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre></div><div class="language- extra-class"><pre><code>{'Abyssinian': 0,
 'Bengal': 1,
 'Birman': 2,
 'Bombay': 3,
 'British_Shorthair': 4}
</code></pre></div><h2 id="time-to-make-and-train-a-model"><a href="#time-to-make-and-train-a-model" class="header-anchor">#</a> Time To Make and Train a Model!</h2> <p>We will be using a convolutional neural network backbone and a fully connected head with a single hidden layer as our classifier. Don't worry if thats a bunch of nonsense for now. Right now, just know this: we are piggybacking off of a model to help us classify images into 37 categories.</p> <p>First we need to make our neural network using a <a href="https://docs.fast.ai/learner#Learner" target="_blank" rel="noopener noreferrer"><code>Learner</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. A <a href="https://docs.fast.ai/learner#Learner" target="_blank" rel="noopener noreferrer"><code>Learner</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> needs (on a basic level):</p> <ul><li><a href="https://docs.fast.ai/data.core#DataLoaders" target="_blank" rel="noopener noreferrer"><code>DataLoaders</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>An architecture</li> <li>An evaluation metric (not actually required for training)</li> <li>A loss function</li> <li>An optimizer</li></ul> <p>We'll also be using <code>mixed_precision</code> (fp16).</p> <p>There are many different <a href="https://docs.fast.ai/learner#Learner" target="_blank" rel="noopener noreferrer"><code>Learner</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> cookie-cutters to use based on what problem you are using it for. Since we're doing transfer learning with CNN's, we will use <a href="https://docs.fast.ai/vision.learner#cnn_learner" target="_blank" rel="noopener noreferrer"><code>cnn_learner</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and a ResNet34:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn <span class="token operator">=</span> cnn_learner<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> resnet34<span class="token punctuation">,</span> pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> metrics<span class="token operator">=</span>error_rate<span class="token punctuation">)</span><span class="token punctuation">.</span>to_fp16<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>Some assumptions and magic is being done here:</p> <ul><li>Loss function is assumed as classification (from the <a href="https://docs.fast.ai/data.core#DataLoaders" target="_blank" rel="noopener noreferrer"><code>DataLoaders</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>), so <a href="https://docs.fast.ai/losses#CrossEntropyLossFlat" target="_blank" rel="noopener noreferrer"><code>CrossEntropyLossFlat</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is being used</li> <li>By default the optimizer is Adam</li> <li>A custom head was added onto our ResNet body, with the body's weights being frozen</li></ul> <p>Now we can train it! We will train for one cycle through all our data:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>fit_one_cycle<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>error_rate</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>1.255419</td> <td>0.317409</td> <td>0.102165</td> <td>00:26</td></tr></tbody></table> <p>Afterwards we can <em>unfreeze</em> those frozen weights and train a little more. We'll utilize the <a href="https://docs.fast.ai/callback.schedule#Learner.lr_find" target="_blank" rel="noopener noreferrer"><code>Learner.lr_find</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> function to help us decide a good learning rate:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>lr_find<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>SuggestedLRs(lr_min=0.00043651582673192023, lr_steep=1.9054607491852948e-06)
</code></pre></div><p><img src="output_49_2.png" alt="png"></p> <p>Alright so if we look here, we don't really start seeing a spike in our losses until we get close to 1e-2, so a good section to train on is between 1e-4 and 1e-3, so we'll do that!</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>unfreeze<span class="token punctuation">(</span><span class="token punctuation">)</span>
learn<span class="token punctuation">.</span>fit_one_cycle<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> lr_max<span class="token operator">=</span><span class="token builtin">slice</span><span class="token punctuation">(</span><span class="token number">1e</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>error_rate</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.627381</td> <td>0.798733</td> <td>0.234100</td> <td>00:27</td></tr> <tr><td>1</td> <td>0.556349</td> <td>0.454100</td> <td>0.144114</td> <td>00:27</td></tr> <tr><td>2</td> <td>0.309109</td> <td>0.257731</td> <td>0.083897</td> <td>00:27</td></tr> <tr><td>3</td> <td>0.146716</td> <td>0.221774</td> <td>0.072395</td> <td>00:27</td></tr></tbody></table> <p>And now we have a fully trained model! At the start we set a goal: to beat 59% accuracy usin gonly the image inputs.</p> <p>We more than succeeded, achieving 94% accuracy while training for only five epochs!</p> <p>To use such a model in production, examples of <code>learn.predict</code> and <code>learn.get_preds</code> with <code>test_dl</code> are shown below:</p> <div class="language-python extra-class"><pre class="language-python"><code>clas<span class="token punctuation">,</span> clas_idx<span class="token punctuation">,</span> probs <span class="token operator">=</span> learn<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>fnames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> clas
</code></pre></div><div class="language- extra-class"><pre><code>'Birman'
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>test_dl <span class="token operator">=</span> learn<span class="token punctuation">.</span>dls<span class="token punctuation">.</span>test_dl<span class="token punctuation">(</span>fnames<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
preds <span class="token operator">=</span> learn<span class="token punctuation">.</span>get_preds<span class="token punctuation">(</span>dl<span class="token operator">=</span>test_dl<span class="token punctuation">)</span>
</code></pre></div><p>To get the class names decoded we can do the following:</p> <div class="language-python extra-class"><pre class="language-python"><code>class_idxs <span class="token operator">=</span> preds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
res <span class="token operator">=</span> <span class="token punctuation">[</span>dls<span class="token punctuation">.</span>vocab<span class="token punctuation">[</span>c<span class="token punctuation">]</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> class_idxs<span class="token punctuation">]</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>res<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>
</code></pre></div><div class="language- extra-class"><pre><code>['Russian_Blue',
 'Bombay',
 'Abyssinian',
 'Persian',
 'Egyptian_Mau',
 'Russian_Blue',
 'Russian_Blue',
 'Bengal',
 'Abyssinian',
 'Egyptian_Mau']
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/walkwithfastai.github.io/assets/js/app.d213da4d.js" defer></script><script src="/walkwithfastai.github.io/assets/js/2.3552a41d.js" defer></script><script src="/walkwithfastai.github.io/assets/js/15.96fcd54f.js" defer></script>
  </body>
</html>
