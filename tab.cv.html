<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Cross Validation (Intermediate)</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Welcome to fastai">
    
    <link rel="preload" href="/walkwithfastai.github.io/assets/css/0.styles.57b101cf.css" as="style"><link rel="preload" href="/walkwithfastai.github.io/assets/js/app.d213da4d.js" as="script"><link rel="preload" href="/walkwithfastai.github.io/assets/js/2.3552a41d.js" as="script"><link rel="preload" href="/walkwithfastai.github.io/assets/js/11.f91edc13.js" as="script"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/10.1c53449a.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/12.c9267090.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/13.905833e1.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/14.71aae364.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/15.96fcd54f.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/16.60f565fe.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/17.6360a1cb.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/3.fb63bfb9.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/4.b52d6096.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/5.1a7d8c98.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/6.86aec1e1.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/7.9883384d.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/8.4b03437f.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/9.0fe2b969.js">
    <link rel="stylesheet" href="/walkwithfastai.github.io/assets/css/0.styles.57b101cf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/walkwithfastai.github.io/" class="home-link router-link-active"><img src="https://www.jovian.ml/fastai_logo.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/walkwithfastai.github.io/" class="nav-link">
  Overview
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Introduction" class="dropdown-title"><span class="title">Introduction</span> <span class="arrow down"></span></button> <button type="button" aria-label="Introduction" class="mobile-dropdown-title"><span class="title">Introduction</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/intro.contribute.html" class="nav-link">
  How to Contribute a Chapter
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vision" class="dropdown-title"><span class="title">Vision</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vision" class="mobile-dropdown-title"><span class="title">Vision</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/vision.intro.html" class="nav-link">
  Introduction
</a></li><li class="dropdown-item"><h4>
          Classification
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/vision.clas.single_label.html" class="nav-link">
  Single Label (Beginner)
</a></li></ul></li><li class="dropdown-item"><h4>
          External Model Integrations
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/vision.external.timm.html" class="nav-link">
  timm
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tabular" class="dropdown-title"><span class="title">Tabular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tabular" class="mobile-dropdown-title"><span class="title">Tabular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/tab.clas.binary.html" class="nav-link">
  Introduction
</a></li><li class="dropdown-item"><h4>
          Classification
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/tab.clas.binary.html" class="nav-link">
  Binary (Beginner)
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/tab.cv.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Cross Validation (Intermediate)
</a></li></ul></div></div> <a href="https://github.com/walkwithfastai/walkwithfastai.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/walkwithfastai.github.io/" class="nav-link">
  Overview
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Introduction" class="dropdown-title"><span class="title">Introduction</span> <span class="arrow down"></span></button> <button type="button" aria-label="Introduction" class="mobile-dropdown-title"><span class="title">Introduction</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/intro.contribute.html" class="nav-link">
  How to Contribute a Chapter
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vision" class="dropdown-title"><span class="title">Vision</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vision" class="mobile-dropdown-title"><span class="title">Vision</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/vision.intro.html" class="nav-link">
  Introduction
</a></li><li class="dropdown-item"><h4>
          Classification
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/vision.clas.single_label.html" class="nav-link">
  Single Label (Beginner)
</a></li></ul></li><li class="dropdown-item"><h4>
          External Model Integrations
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/vision.external.timm.html" class="nav-link">
  timm
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tabular" class="dropdown-title"><span class="title">Tabular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tabular" class="mobile-dropdown-title"><span class="title">Tabular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/tab.clas.binary.html" class="nav-link">
  Introduction
</a></li><li class="dropdown-item"><h4>
          Classification
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/tab.clas.binary.html" class="nav-link">
  Binary (Beginner)
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/tab.cv.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Cross Validation (Intermediate)
</a></li></ul></div></div> <a href="https://github.com/walkwithfastai/walkwithfastai.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Cross Validation (Intermediate)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/walkwithfastai.github.io/tab.cv.html#importing-the-library-and-the-dataset" class="sidebar-link">Importing the Library and the Dataset</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/walkwithfastai.github.io/tab.cv.html#k-fold" class="sidebar-link">K-Fold</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/walkwithfastai.github.io/tab.cv.html#introduction-2" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/walkwithfastai.github.io/tab.cv.html#extra-preprocessing" class="sidebar-link">Extra Preprocessing</a></li><li class="sidebar-sub-header"><a href="/walkwithfastai.github.io/tab.cv.html#now-let-s-train" class="sidebar-link">Now Let's Train</a></li></ul></li><li><a href="/walkwithfastai.github.io/tab.cv.html#stratified-k-fold" class="sidebar-link">Stratified K-Fold</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/walkwithfastai.github.io/tab.cv.html#multi-label-stratified-k-fold" class="sidebar-link">Multi-Label Stratified K-Fold</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="cross-validation-intermediate"><a href="#cross-validation-intermediate" class="header-anchor">#</a> Cross Validation (Intermediate)</h1> <blockquote><p>How to perform various Cross Validation methodologies</p></blockquote> <hr> <p>This article is also a Jupyter Notebook available to be run from the top down. There
will be code snippets that you can then run in any environment.</p> <p>Below are the versions of <code>fastai</code>, <code>fastcore</code>, <code>scikit-learn</code>, and <code>iterative-stratification</code> currently running at the time of writing this:</p> <ul><li><code>fastai</code>: 2.0.14</li> <li><code>fastcore</code>: 1.0.14</li> <li><code>scikit-learn</code>: 0.22.2.post1</li> <li><code>iterative-stratification</code>: 0.1.6</li></ul> <hr> <h1 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h1> <p>In this tutorial we will show how to use various cross validation methodologies inside of <code>fastai</code>  with the <code>tabular</code> and <code>vision</code> libraries. First, let's walk through a <code>tabular</code> example</p> <h1 id="tabular"><a href="#tabular" class="header-anchor">#</a> Tabular</h1> <h2 id="importing-the-library-and-the-dataset"><a href="#importing-the-library-and-the-dataset" class="header-anchor">#</a> Importing the Library and the Dataset</h2> <p>We'll be using the <code>tabular</code> module for the first example, along with the <code>ADULTS</code> dataset. Let's grab those:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> fastai<span class="token punctuation">.</span>tabular<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">import</span> <span class="token operator">*</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>path <span class="token operator">=</span> untar_data<span class="token punctuation">(</span>URLs<span class="token punctuation">.</span>ADULT_SAMPLE<span class="token punctuation">)</span>
</code></pre></div><p>Let's open it in <code>Pandas</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code>df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>path<span class="token operator">/</span><span class="token string">'adult.csv'</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div><style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&lt;!--beforebegin--&gt;&lt;div class=&quot;language- extra-class&quot;&gt;&lt;!--afterbegin--&gt;&lt;pre&gt;&lt;code&gt;.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;!--beforeend--&gt;&lt;/div&gt;&lt;!--afterend--&gt;</style> <table border="1" class="dataframe"><thead><tr style="text-align:right;"><th></th> <th>age</th> <th>workclass</th> <th>fnlwgt</th> <th>education</th> <th>education-num</th> <th>marital-status</th> <th>occupation</th> <th>relationship</th> <th>race</th> <th>sex</th> <th>capital-gain</th> <th>capital-loss</th> <th>hours-per-week</th> <th>native-country</th> <th>salary</th></tr></thead> <tbody><tr><th>0</th> <td>49</td> <td>Private</td> <td>101320</td> <td>Assoc-acdm</td> <td>12.0</td> <td>Married-civ-spouse</td> <td>NaN</td> <td>Wife</td> <td>White</td> <td>Female</td> <td>0</td> <td>1902</td> <td>40</td> <td>United-States</td> <td>&gt;=50k</td></tr> <tr><th>1</th> <td>44</td> <td>Private</td> <td>236746</td> <td>Masters</td> <td>14.0</td> <td>Divorced</td> <td>Exec-managerial</td> <td>Not-in-family</td> <td>White</td> <td>Male</td> <td>10520</td> <td>0</td> <td>45</td> <td>United-States</td> <td>&gt;=50k</td></tr> <tr><th>2</th> <td>38</td> <td>Private</td> <td>96185</td> <td>HS-grad</td> <td>NaN</td> <td>Divorced</td> <td>NaN</td> <td>Unmarried</td> <td>Black</td> <td>Female</td> <td>0</td> <td>0</td> <td>32</td> <td>United-States</td> <td>&lt;50k</td></tr> <tr><th>3</th> <td>38</td> <td>Self-emp-inc</td> <td>112847</td> <td>Prof-school</td> <td>15.0</td> <td>Married-civ-spouse</td> <td>Prof-specialty</td> <td>Husband</td> <td>Asian-Pac-Islander</td> <td>Male</td> <td>0</td> <td>0</td> <td>40</td> <td>United-States</td> <td>&gt;=50k</td></tr> <tr><th>4</th> <td>42</td> <td>Self-emp-not-inc</td> <td>82297</td> <td>7th-8th</td> <td>NaN</td> <td>Married-civ-spouse</td> <td>Other-service</td> <td>Wife</td> <td>Black</td> <td>Female</td> <td>0</td> <td>0</td> <td>50</td> <td>United-States</td> <td>&lt;50k</td></tr></tbody></table></div> <p>Next we want to create a constant test set and declare our various variables and <code>procs</code>. We'll just be using the last 10% of the data, however figuring out how to make your test set is a very important problem. To read more, see Rachel Thomas' article on <a href="https://www.fast.ai/2017/11/13/validation-sets/" target="_blank" rel="noopener noreferrer">How (and why) to create a good validation set<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.
{% include note.html content='we call it a test set here as we make our own mini validation sets when we’re training' %}</p> <div class="language-python extra-class"><pre class="language-python"><code>cat_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'workclass'</span><span class="token punctuation">,</span> <span class="token string">'education'</span><span class="token punctuation">,</span> <span class="token string">'marital-status'</span><span class="token punctuation">,</span> <span class="token string">'occupation'</span><span class="token punctuation">,</span> <span class="token string">'relationship'</span><span class="token punctuation">,</span> <span class="token string">'race'</span><span class="token punctuation">]</span>
cont_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'fnlwgt'</span><span class="token punctuation">,</span> <span class="token string">'education-num'</span><span class="token punctuation">]</span>
procs <span class="token operator">=</span> <span class="token punctuation">[</span>Categorify<span class="token punctuation">,</span> FillMissing<span class="token punctuation">,</span> Normalize<span class="token punctuation">]</span>
</code></pre></div><p>And now we'll split our dataset:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'10% of our data is </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">.1</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> rows'</span></span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>10% of our data is 3256 rows
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>start_val <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">3256</span><span class="token punctuation">;</span> start_val
</code></pre></div><div class="language- extra-class"><pre><code>29305
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>train <span class="token operator">=</span> df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span>start_val<span class="token punctuation">]</span>
test <span class="token operator">=</span> df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>start_val<span class="token punctuation">:</span><span class="token punctuation">]</span>
</code></pre></div><p>Now that we have the <code>DataFrames</code>, let's look into a few different CV methods:</p> <h2 id="k-fold"><a href="#k-fold" class="header-anchor">#</a> K-Fold</h2> <p>Every Cross Validation method is slightly different, and what version you should use depends on the dataset you are utilizing. The general idea of Cross Validation is we split the dataset into <code>n</code> sets (usually five is enough), train five seperate models, and then at the end we can ensemble them together. This should in theory make a group of models that performs better than one model on the entire dataset.</p> <p>As we are training, there is zero overlap in the validation sets whatsoever. As a result we create five distinct validation sets.</p> <h3 id="introduction-2"><a href="#introduction-2" class="header-anchor">#</a> Introduction</h3> <p>Now for the <code>kfold</code>. We'll first be using <code>sklearn</code>'s <code>KFold</code> class. This method works by running through all the indicies available and seperating out the folds. For a minimum example, take the following:</p> <div class="language-python extra-class"><pre class="language-python"><code>train_idxs <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
test_idxs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span>
</code></pre></div><p>We now have some training indicies and a test set:</p> <div class="language-python extra-class"><pre class="language-python"><code>train_idxs<span class="token punctuation">,</span> test_idxs
</code></pre></div><div class="language- extra-class"><pre><code>([0, 1, 2, 3, 4, 5, 6, 7, 8], [10])
</code></pre></div><p>Now we can instantiate a <code>KFold</code> object, passing in the number of splits, whether to shuffle the data before splitting into folds, and potentially a seed:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> KFold
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>dummy_kf <span class="token operator">=</span> KFold<span class="token punctuation">(</span>n_splits<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">;</span> dummy_kf
</code></pre></div><div class="language- extra-class"><pre><code>KFold(n_splits=5, random_state=None, shuffle=False)
</code></pre></div><p>And now we can run through our splits by iterating through train and valid indexes. We pass in our <code>x</code> data through <code>dummy_kf.split</code> to get the indexes</p> <blockquote><p>You could also pass in your <code>y</code>'s intead:</p></blockquote> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">for</span> train_idx<span class="token punctuation">,</span> valid_idx <span class="token keyword">in</span> dummy_kf<span class="token punctuation">.</span>split<span class="token punctuation">(</span>train_idxs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Train: </span><span class="token interpolation"><span class="token punctuation">{</span>train_idx<span class="token punctuation">}</span></span><span class="token string">, Valid: </span><span class="token interpolation"><span class="token punctuation">{</span>valid_idx<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>Train: [2 3 4 5 6 7 8], Valid: [0 1]
Train: [0 1 4 5 6 7 8], Valid: [2 3]
Train: [0 1 2 3 6 7 8], Valid: [4 5]
Train: [0 1 2 3 4 5 8], Valid: [6 7]
Train: [0 1 2 3 4 5 6 7], Valid: [8]
</code></pre></div><h3 id="extra-preprocessing"><a href="#extra-preprocessing" class="header-anchor">#</a> Extra Preprocessing</h3> <p>Now the question is how can I use this when training on our data?</p> <p>When we preprocess our tabular training dataset, we build our <code>procs</code> based upon it. When doing a CV (Cross Validation) we will often exclude some data as it gets pushed to the validation set, leading to such errors as:</p> <div class="language- extra-class"><pre><code>---------------------------------------------------------------------------

AssertionError                            Traceback (most recent call last)

&lt;ipython-input-16-59d14331bcbc&gt; in &lt;module&gt;()
      1 #hide_input
----&gt; 2 raise AssertionError('nan values in `education-num` but not in setup training set')


AssertionError: nan values in `education-num` but not in setup training set
</code></pre></div><p>So how do we fix this? We should preprocess the entire training <code>DataFrame</code> into <a href="https://docs.fast.ai/tabular.core#TabularPandas" target="_blank" rel="noopener noreferrer"><code>TabularPandas</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> first, this way we can extract all the <code>proc</code> information. Let's do that now:</p> <div class="language-python extra-class"><pre class="language-python"><code>to_base <span class="token operator">=</span> TabularPandas<span class="token punctuation">(</span>train<span class="token punctuation">,</span> procs<span class="token punctuation">,</span> cat_names<span class="token punctuation">,</span> cont_names<span class="token punctuation">,</span> y_names<span class="token operator">=</span><span class="token string">'salary'</span><span class="token punctuation">)</span>
</code></pre></div><p>Next we need to extract all the information we need. This includes:</p> <ul><li><a href="/walkwithfastai.github.io/tab.stats.html#Categorify"><code>Categorify</code></a>'s classes</li> <li><a href="https://docs.fast.ai/data.transforms#Normalize" target="_blank" rel="noopener noreferrer"><code>Normalize</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>'s <code>means</code> and <code>stds</code></li> <li><a href="/walkwithfastai.github.io/tab.stats.html#FillMissing"><code>FillMissing</code></a>'s <code>fill_vals</code> and <code>na_dict</code></li></ul> <div class="language-python extra-class"><pre class="language-python"><code>classes <span class="token operator">=</span> to_base<span class="token punctuation">.</span>classes
means<span class="token punctuation">,</span> stds <span class="token operator">=</span> to_base<span class="token punctuation">.</span>normalize<span class="token punctuation">.</span>means<span class="token punctuation">,</span> to_base<span class="token punctuation">.</span>normalize<span class="token punctuation">.</span>stds
fill_vals<span class="token punctuation">,</span> na_dict <span class="token operator">=</span> to_base<span class="token punctuation">.</span>fill_missing<span class="token punctuation">.</span>fill_vals<span class="token punctuation">,</span> to_base<span class="token punctuation">.</span>fill_missing<span class="token punctuation">.</span>na_dict
</code></pre></div><p>Now we could generate new procs based on those and apply them to our dataset:</p> <div class="language-python extra-class"><pre class="language-python"><code>procs <span class="token operator">=</span> <span class="token punctuation">[</span>Categorify<span class="token punctuation">(</span>classes<span class="token punctuation">)</span><span class="token punctuation">,</span> Normalize<span class="token punctuation">.</span>from_tab<span class="token punctuation">(</span>means<span class="token punctuation">,</span> stds<span class="token punctuation">)</span><span class="token punctuation">,</span> FillMissing<span class="token punctuation">(</span>fill_strategy<span class="token operator">=</span>FillStrategy<span class="token punctuation">.</span>median<span class="token punctuation">,</span> fill_vals<span class="token operator">=</span>fill_vals<span class="token punctuation">,</span> na_dict<span class="token operator">=</span>na_dict<span class="token punctuation">)</span><span class="token punctuation">]</span>
</code></pre></div><h3 id="now-let-s-train"><a href="#now-let-s-train" class="header-anchor">#</a> Now Let's Train</h3> <p>Now that we have our adjusted <code>procs</code>, let's try training.</p> <p>We'll want to make a loop that will do the following:</p> <ol><li>Make our <code>KFold</code> and split</li> <li>Build a <a href="https://docs.fast.ai/tabular.core#TabularPandas" target="_blank" rel="noopener noreferrer"><code>TabularPandas</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> object given our splits</li> <li>Train for some training regiment</li> <li>Get predictions on the <a href="https://fastcore.fast.ai/test#test" target="_blank" rel="noopener noreferrer"><code>test</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> set, and potentially keep track of any statistics.</li></ol> <p>Let's do so below:</p> <div class="language-python extra-class"><pre class="language-python"><code>val_pct<span class="token punctuation">,</span> tst_preds <span class="token operator">=</span> L<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> L<span class="token punctuation">(</span><span class="token punctuation">)</span>
kf <span class="token operator">=</span> KFold<span class="token punctuation">(</span>n_splits<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> train_idx<span class="token punctuation">,</span> valid_idx <span class="token keyword">in</span> kf<span class="token punctuation">.</span>split<span class="token punctuation">(</span>train<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>
    splits <span class="token operator">=</span> <span class="token punctuation">(</span>L<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>train_idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> L<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>valid_idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    procs <span class="token operator">=</span> <span class="token punctuation">[</span>Categorify<span class="token punctuation">(</span>classes<span class="token punctuation">)</span><span class="token punctuation">,</span> Normalize<span class="token punctuation">.</span>from_tab<span class="token punctuation">(</span>means<span class="token punctuation">,</span> stds<span class="token punctuation">)</span><span class="token punctuation">,</span> FillMissing<span class="token punctuation">(</span>fill_strategy<span class="token operator">=</span>FillStrategy<span class="token punctuation">.</span>median<span class="token punctuation">,</span> fill_vals<span class="token operator">=</span>fill_vals<span class="token punctuation">,</span> na_dict<span class="token operator">=</span>na_dict<span class="token punctuation">)</span><span class="token punctuation">]</span>
    to <span class="token operator">=</span> TabularPandas<span class="token punctuation">(</span>train<span class="token punctuation">,</span> procs<span class="token punctuation">,</span> cat_names<span class="token punctuation">,</span> cont_names<span class="token punctuation">,</span> y_names<span class="token operator">=</span><span class="token string">'salary'</span><span class="token punctuation">,</span>
                       splits<span class="token operator">=</span>splits<span class="token punctuation">)</span>
    dls <span class="token operator">=</span> to<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>bs<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">)</span>
    learn <span class="token operator">=</span> tabular_learner<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> layers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">,</span> metrics<span class="token operator">=</span>accuracy<span class="token punctuation">)</span>
    learn<span class="token punctuation">.</span>fit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
    test_dl <span class="token operator">=</span> learn<span class="token punctuation">.</span>dls<span class="token punctuation">.</span>test_dl<span class="token punctuation">(</span>test<span class="token punctuation">)</span>
    <span class="token keyword">with</span> learn<span class="token punctuation">.</span>no_bar<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        val_pct<span class="token punctuation">.</span>append<span class="token punctuation">(</span>learn<span class="token punctuation">.</span>validate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        tst_preds<span class="token punctuation">.</span>append<span class="token punctuation">(</span>learn<span class="token punctuation">.</span>get_preds<span class="token punctuation">(</span>dl<span class="token operator">=</span>test_dl<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>accuracy</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.379017</td> <td>0.380708</td> <td>0.826992</td> <td>00:00</td></tr> <tr><td>1</td> <td>0.364980</td> <td>0.359392</td> <td>0.832281</td> <td>00:00</td></tr> <tr><td>2</td> <td>0.355631</td> <td>0.361775</td> <td>0.825456</td> <td>00:00</td></tr></tbody></table> <table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>accuracy</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.382340</td> <td>0.376627</td> <td>0.829039</td> <td>00:00</td></tr> <tr><td>1</td> <td>0.362212</td> <td>0.366542</td> <td>0.832111</td> <td>00:00</td></tr> <tr><td>2</td> <td>0.355434</td> <td>0.372222</td> <td>0.830063</td> <td>00:00</td></tr></tbody></table> <table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>accuracy</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.385911</td> <td>0.374170</td> <td>0.843542</td> <td>00:00</td></tr> <tr><td>1</td> <td>0.368800</td> <td>0.339751</td> <td>0.842348</td> <td>00:00</td></tr> <tr><td>2</td> <td>0.360772</td> <td>0.349895</td> <td>0.843542</td> <td>00:00</td></tr></tbody></table> <table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>accuracy</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.377877</td> <td>0.358854</td> <td>0.835523</td> <td>00:00</td></tr> <tr><td>1</td> <td>0.362264</td> <td>0.362680</td> <td>0.833646</td> <td>00:00</td></tr> <tr><td>2</td> <td>0.355874</td> <td>0.363413</td> <td>0.833134</td> <td>00:00</td></tr></tbody></table> <table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>accuracy</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.380469</td> <td>0.358595</td> <td>0.838423</td> <td>00:00</td></tr> <tr><td>1</td> <td>0.363201</td> <td>0.352324</td> <td>0.837912</td> <td>00:00</td></tr> <tr><td>2</td> <td>0.356388</td> <td>0.350427</td> <td>0.837741</td> <td>00:00</td></tr></tbody></table> <p>Now let's take a look at our results:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>pred<span class="token punctuation">,</span> truth<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>tst_preds<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Fold </span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>accuracy<span class="token punctuation">(</span>pred<span class="token punctuation">,</span> truth<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>Fold 1: 0.8390663266181946
Fold 2: 0.834152340888977
Fold 3: 0.8320024609565735
Fold 4: 0.8356879353523254
Fold 5: 0.8329238295555115
</code></pre></div><p>Let's try ensembling them and seeing what happens:</p> <div class="language-python extra-class"><pre class="language-python"><code>sum_preds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>pred<span class="token punctuation">,</span> truth<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>tst_preds<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sum_preds<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pred<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
avg_preds <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>sum_preds<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">5</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Average Accuracy: </span><span class="token interpolation"><span class="token punctuation">{</span>accuracy<span class="token punctuation">(</span>tensor<span class="token punctuation">(</span>avg_preds<span class="token punctuation">)</span><span class="token punctuation">,</span> tst_preds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>Average Accuracy: 0.8366093635559082
</code></pre></div><p>As we can see, ensembling all the models together boosted our score by .1%. Not the highest of increases though! Let's try out another CV method and see if it works better</p> <h2 id="stratified-k-fold"><a href="#stratified-k-fold" class="header-anchor">#</a> Stratified K-Fold</h2> <p>While the first example simply split our dataset either randomly (if we passed <code>True</code>) or just down the indicies, there are a multitude of cases where we won't have perfectly balanced classes (where the previous example would be useful). What can we do in such a situation?</p> <p>Stratified K-Fold Validation allows us to split our data while also preserving the percentage of samples inside of each class. We'll follow the same methodology as we did before with a few minor changes to have it work with Stratified K-Fold</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> StratifiedKFold
</code></pre></div><p>The only difference is along with our <code>train.index</code> we also need to pass in our <code>y</code>'s so it can gather the class distributions:</p> <div class="language-python extra-class"><pre class="language-python"><code>val_pct<span class="token punctuation">,</span> tst_preds <span class="token operator">=</span> L<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> L<span class="token punctuation">(</span><span class="token punctuation">)</span>
skf <span class="token operator">=</span> StratifiedKFold<span class="token punctuation">(</span>n_splits<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> train_idx<span class="token punctuation">,</span> valid_idx <span class="token keyword">in</span> kf<span class="token punctuation">.</span>split<span class="token punctuation">(</span>train<span class="token punctuation">.</span>index<span class="token punctuation">,</span> train<span class="token punctuation">[</span><span class="token string">'salary'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># right here</span>
    splits <span class="token operator">=</span> <span class="token punctuation">(</span>L<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>train_idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> L<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>valid_idx<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    procs <span class="token operator">=</span> <span class="token punctuation">[</span>Categorify<span class="token punctuation">(</span>classes<span class="token punctuation">)</span><span class="token punctuation">,</span> Normalize<span class="token punctuation">.</span>from_tab<span class="token punctuation">(</span>means<span class="token punctuation">,</span> stds<span class="token punctuation">)</span><span class="token punctuation">,</span> FillMissing<span class="token punctuation">(</span>fill_strategy<span class="token operator">=</span>FillStrategy<span class="token punctuation">.</span>median<span class="token punctuation">,</span> fill_vals<span class="token operator">=</span>fill_vals<span class="token punctuation">,</span> na_dict<span class="token operator">=</span>na_dict<span class="token punctuation">)</span><span class="token punctuation">]</span>
    to <span class="token operator">=</span> TabularPandas<span class="token punctuation">(</span>train<span class="token punctuation">,</span> procs<span class="token punctuation">,</span> cat_names<span class="token punctuation">,</span> cont_names<span class="token punctuation">,</span> y_names<span class="token operator">=</span><span class="token string">'salary'</span><span class="token punctuation">,</span>
                       splits<span class="token operator">=</span>splits<span class="token punctuation">)</span>
    dls <span class="token operator">=</span> to<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>bs<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">)</span>
    learn <span class="token operator">=</span> tabular_learner<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> layers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">,</span> metrics<span class="token operator">=</span>accuracy<span class="token punctuation">)</span>
    learn<span class="token punctuation">.</span>fit<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1e</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
    test_dl <span class="token operator">=</span> learn<span class="token punctuation">.</span>dls<span class="token punctuation">.</span>test_dl<span class="token punctuation">(</span>test<span class="token punctuation">)</span>
    <span class="token keyword">with</span> learn<span class="token punctuation">.</span>no_bar<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        val_pct<span class="token punctuation">.</span>append<span class="token punctuation">(</span>learn<span class="token punctuation">.</span>validate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        tst_preds<span class="token punctuation">.</span>append<span class="token punctuation">(</span>learn<span class="token punctuation">.</span>get_preds<span class="token punctuation">(</span>dl<span class="token operator">=</span>test_dl<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>accuracy</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.377596</td> <td>0.366456</td> <td>0.831599</td> <td>00:00</td></tr> <tr><td>1</td> <td>0.360850</td> <td>0.361772</td> <td>0.827674</td> <td>00:00</td></tr> <tr><td>2</td> <td>0.356481</td> <td>0.359992</td> <td>0.831257</td> <td>00:00</td></tr></tbody></table> <table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>accuracy</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.377417</td> <td>0.388749</td> <td>0.822726</td> <td>00:00</td></tr> <tr><td>1</td> <td>0.360371</td> <td>0.376890</td> <td>0.824774</td> <td>00:00</td></tr> <tr><td>2</td> <td>0.352614</td> <td>0.368503</td> <td>0.833817</td> <td>00:00</td></tr></tbody></table> <table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>accuracy</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.387596</td> <td>0.358673</td> <td>0.842177</td> <td>00:00</td></tr> <tr><td>1</td> <td>0.368236</td> <td>0.347018</td> <td>0.844907</td> <td>00:00</td></tr> <tr><td>2</td> <td>0.362123</td> <td>0.345612</td> <td>0.841324</td> <td>00:00</td></tr></tbody></table> <table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>accuracy</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.375481</td> <td>0.365665</td> <td>0.836205</td> <td>00:00</td></tr> <tr><td>1</td> <td>0.358180</td> <td>0.362090</td> <td>0.832111</td> <td>00:00</td></tr> <tr><td>2</td> <td>0.351982</td> <td>0.360600</td> <td>0.830404</td> <td>00:00</td></tr></tbody></table> <table border="1" class="dataframe"><thead><tr style="text-align:left;"><th>epoch</th> <th>train_loss</th> <th>valid_loss</th> <th>accuracy</th> <th>time</th></tr></thead> <tbody><tr><td>0</td> <td>0.385218</td> <td>0.363116</td> <td>0.831428</td> <td>00:00</td></tr> <tr><td>1</td> <td>0.363915</td> <td>0.349798</td> <td>0.836717</td> <td>00:00</td></tr> <tr><td>2</td> <td>0.356412</td> <td>0.354061</td> <td>0.837400</td> <td>00:00</td></tr></tbody></table> <p>Let's see how our new version fairs up:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>pred<span class="token punctuation">,</span> truth<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>tst_preds<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Fold </span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>accuracy<span class="token punctuation">(</span>pred<span class="token punctuation">,</span> truth<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>Fold 1: 0.8335380554199219
Fold 2: 0.835073709487915
Fold 3: 0.8316953182220459
Fold 4: 0.8412162065505981
Fold 5: 0.8387592434883118
</code></pre></div><p>We can see that so far it looks a bit better (we actually have one with 84%!).</p> <p>Now let's try the ensemble:</p> <div class="language-python extra-class"><pre class="language-python"><code>sum_preds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>pred<span class="token punctuation">,</span> truth<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>tst_preds<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sum_preds<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pred<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
avg_preds <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>sum_preds<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">5</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Average Accuracy: </span><span class="token interpolation"><span class="token punctuation">{</span>accuracy<span class="token punctuation">(</span>tensor<span class="token punctuation">(</span>avg_preds<span class="token punctuation">)</span><span class="token punctuation">,</span> tst_preds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>Average Accuracy: 0.835995078086853
</code></pre></div><p>Not quite as well in the ensemble (down by 0.1%), however I would trust this version much <em>much</em> more than the regular <code>KFold</code>.</p> <p>Why?</p> <p>Stratification ensures that we maintain the original distribution of our <code>y</code> values, ensuring that if we have rare classes they will always show up and be trained on. Now let's look at a multi-label example.</p> <h2 id="multi-label-stratified-k-fold"><a href="#multi-label-stratified-k-fold" class="header-anchor">#</a> Multi-Label Stratified K-Fold</h2> <p>To run Multi-Label Stratified K-Fold, I will show an example below, but we will not run it (as there currently isn't quite a close enough dataset outside of Kaggle right now).</p> <p>First we'll need to import our <code>MultilabelStratifiedKfold</code> from <code>iterstrat</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> iterstrat<span class="token punctuation">.</span>ml_stratifiers <span class="token keyword">import</span> MultilabelStratifiedKFold
</code></pre></div><p>Then when following our above method (ensure you have your <code>loss_func</code>, etc properly setup), we simply replace our <code>for train_idx, valid_idx</code> with:</p> <div class="language-python extra-class"><pre class="language-python"><code>mskf <span class="token operator">=</span> MultilabelStratifiedKFold<span class="token punctuation">(</span>n_splits<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> train_idx<span class="token punctuation">,</span> val_idx <span class="token keyword">in</span> mskf<span class="token punctuation">.</span>split<span class="token punctuation">(</span>X<span class="token operator">=</span>train<span class="token punctuation">,</span> y<span class="token operator">=</span>train<span class="token punctuation">[</span>y_names<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">&quot;blah&quot;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/walkwithfastai.github.io/assets/js/app.d213da4d.js" defer></script><script src="/walkwithfastai.github.io/assets/js/2.3552a41d.js" defer></script><script src="/walkwithfastai.github.io/assets/js/11.f91edc13.js" defer></script>
  </body>
</html>
