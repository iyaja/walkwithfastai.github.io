<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Using Custom Transform Statistics (Intermediate)</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Welcome to fastai">
    
    <link rel="preload" href="/walkwithfastai.github.io/assets/css/0.styles.57b101cf.css" as="style"><link rel="preload" href="/walkwithfastai.github.io/assets/js/app.d213da4d.js" as="script"><link rel="preload" href="/walkwithfastai.github.io/assets/js/2.3552a41d.js" as="script"><link rel="preload" href="/walkwithfastai.github.io/assets/js/13.905833e1.js" as="script"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/10.1c53449a.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/11.f91edc13.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/12.c9267090.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/14.71aae364.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/15.96fcd54f.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/16.60f565fe.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/17.6360a1cb.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/3.fb63bfb9.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/4.b52d6096.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/5.1a7d8c98.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/6.86aec1e1.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/7.9883384d.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/8.4b03437f.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/9.0fe2b969.js">
    <link rel="stylesheet" href="/walkwithfastai.github.io/assets/css/0.styles.57b101cf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/walkwithfastai.github.io/" class="home-link router-link-active"><img src="https://www.jovian.ml/fastai_logo.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/walkwithfastai.github.io/" class="nav-link">
  Overview
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Introduction" class="dropdown-title"><span class="title">Introduction</span> <span class="arrow down"></span></button> <button type="button" aria-label="Introduction" class="mobile-dropdown-title"><span class="title">Introduction</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/intro.contribute.html" class="nav-link">
  How to Contribute a Chapter
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vision" class="dropdown-title"><span class="title">Vision</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vision" class="mobile-dropdown-title"><span class="title">Vision</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/vision.intro.html" class="nav-link">
  Introduction
</a></li><li class="dropdown-item"><h4>
          Classification
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/vision.clas.single_label.html" class="nav-link">
  Single Label (Beginner)
</a></li></ul></li><li class="dropdown-item"><h4>
          External Model Integrations
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/vision.external.timm.html" class="nav-link">
  timm
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tabular" class="dropdown-title"><span class="title">Tabular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tabular" class="mobile-dropdown-title"><span class="title">Tabular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/tab.clas.binary.html" class="nav-link">
  Introduction
</a></li><li class="dropdown-item"><h4>
          Classification
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/tab.clas.binary.html" class="nav-link">
  Binary (Beginner)
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/tab.cv.html" class="nav-link">
  Cross Validation (Intermediate)
</a></li></ul></div></div> <a href="https://github.com/walkwithfastai/walkwithfastai.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/walkwithfastai.github.io/" class="nav-link">
  Overview
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Introduction" class="dropdown-title"><span class="title">Introduction</span> <span class="arrow down"></span></button> <button type="button" aria-label="Introduction" class="mobile-dropdown-title"><span class="title">Introduction</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/intro.contribute.html" class="nav-link">
  How to Contribute a Chapter
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vision" class="dropdown-title"><span class="title">Vision</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vision" class="mobile-dropdown-title"><span class="title">Vision</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/vision.intro.html" class="nav-link">
  Introduction
</a></li><li class="dropdown-item"><h4>
          Classification
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/vision.clas.single_label.html" class="nav-link">
  Single Label (Beginner)
</a></li></ul></li><li class="dropdown-item"><h4>
          External Model Integrations
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/vision.external.timm.html" class="nav-link">
  timm
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tabular" class="dropdown-title"><span class="title">Tabular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tabular" class="mobile-dropdown-title"><span class="title">Tabular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/tab.clas.binary.html" class="nav-link">
  Introduction
</a></li><li class="dropdown-item"><h4>
          Classification
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/tab.clas.binary.html" class="nav-link">
  Binary (Beginner)
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/tab.cv.html" class="nav-link">
  Cross Validation (Intermediate)
</a></li></ul></div></div> <a href="https://github.com/walkwithfastai/walkwithfastai.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Using Custom Transform Statistics (Intermediate)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/walkwithfastai.github.io/tab.stats.html#why-use-predetermined-stats" class="sidebar-link">Why Use Predetermined Stats?</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/walkwithfastai.github.io/tab.stats.html#modifying-the-procs" class="sidebar-link">Modifying the procs</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/walkwithfastai.github.io/tab.stats.html#categorify" class="sidebar-link">Categorify</a></li><li class="sidebar-sub-header"><a href="/walkwithfastai.github.io/tab.stats.html#normalize" class="sidebar-link">Normalize</a></li><li class="sidebar-sub-header"><a href="/walkwithfastai.github.io/tab.stats.html#fillmissing" class="sidebar-link">FillMissing</a></li></ul></li><li><a href="/walkwithfastai.github.io/tab.stats.html#full-integration-example" class="sidebar-link">Full Integration Example</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/walkwithfastai.github.io/tab.stats.html#categorify-2" class="sidebar-link">Categorify</a></li><li class="sidebar-sub-header"><a href="/walkwithfastai.github.io/tab.stats.html#normalize-2" class="sidebar-link">Normalize</a></li><li class="sidebar-sub-header"><a href="/walkwithfastai.github.io/tab.stats.html#fillmissing-2" class="sidebar-link">FillMissing</a></li><li class="sidebar-sub-header"><a href="/walkwithfastai.github.io/tab.stats.html#bringing-it-together" class="sidebar-link">Bringing it together</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="using-custom-transform-statistics-intermediate"><a href="#using-custom-transform-statistics-intermediate" class="header-anchor">#</a> Using Custom Transform Statistics (Intermediate)</h1> <blockquote><p>A guide for showing how to bring in pregenerated statistics for tabular</p></blockquote> <hr> <p>This article is also a Jupyter Notebook available to be run from the top down. There
will be code snippets that you can then run in any environment.</p> <p>Below are the versions of <code>fastai</code>, <code>fastcore</code>, and <code>wwf</code> currently running at the time of writing this:</p> <ul><li><code>fastai</code>: 2.0.16</li> <li><code>fastcore</code>: 1.1.2</li> <li><code>wwf</code>: 0.0.4</li></ul> <hr> <h2 id="why-use-predetermined-stats"><a href="#why-use-predetermined-stats" class="header-anchor">#</a> Why Use Predetermined Stats?</h2> <p>If <code>fastai</code> will simply let us pass everything to a <a href="https://docs.fast.ai/tabular.core#TabularPandas" target="_blank" rel="noopener noreferrer"><code>TabularPandas</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> object to preprocess and train on, why should having custom statistics for our data?</p> <p>Let's try to think of a scenario.</p> <p>My data is a few <em>trillion</em> rows, so there is no way (currently) I can load this <code>DataFrame</code> into memory at once. What do I do? Perhaps I would want to train on batches of my data at a time (article on this will come soon). To do this though I would <strong>need</strong> all of my <code>procs</code> predetermined from the start so every transform is done the same across all of our mini-batches of data.</p> <p>Currently there is an <a href="https://github.com/fastai/fastai/pull/2837" target="_blank" rel="noopener noreferrer">open PR<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for this integration, so for now this will live inside of Walk with fastai and we'll show how to use it as well!</p> <p>Before we begin, let's import the tabular module:</p> <h2 id="modifying-the-procs"><a href="#modifying-the-procs" class="header-anchor">#</a> Modifying the <code>procs</code></h2> <p>Now let's modify each of our <code>procs</code> to have this ability, as right now it's currently not there!</p> <h3 id="categorify"><a href="#categorify" class="header-anchor">#</a> Categorify</h3> <p>The first one we will look at is <a href="/walkwithfastai.github.io/tab.stats.html#Categorify"><code>Categorify</code></a>. Currently the source code looks like so:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Categorify</span><span class="token punctuation">(</span>TabularProc<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">&quot;Transform the categorical variables to something similar to `pd.Categorical`&quot;</span>
    order <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">def</span> <span class="token function">setups</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">:</span>
        store_attr<span class="token punctuation">(</span>classes<span class="token operator">=</span><span class="token punctuation">{</span>n<span class="token punctuation">:</span>CategoryMap<span class="token punctuation">(</span>to<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>items<span class="token punctuation">,</span> add_na<span class="token operator">=</span><span class="token punctuation">(</span>n <span class="token keyword">in</span> to<span class="token punctuation">.</span>cat_names<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> to<span class="token punctuation">.</span>cat_names<span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">encodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">:</span> to<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>to<span class="token punctuation">.</span>cat_names<span class="token punctuation">,</span> partial<span class="token punctuation">(</span>_apply_cats<span class="token punctuation">,</span> self<span class="token punctuation">.</span>classes<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">decodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">:</span> to<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>to<span class="token punctuation">.</span>cat_names<span class="token punctuation">,</span> partial<span class="token punctuation">(</span>_decode_cats<span class="token punctuation">,</span> self<span class="token punctuation">.</span>classes<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> self<span class="token punctuation">.</span>classes<span class="token punctuation">[</span>k<span class="token punctuation">]</span>
</code></pre></div><p>What our modification needs to do is on the <code>__init__</code> we need an option to pass in a dictionary of class mappings, and <a href="/walkwithfastai.github.io/tab.stats.html#setups"><code>setups</code></a> needs to generate class mappings for those not passed in. Let's do so below:</p> <h2 id="Categorify" class="doc_header"><code>class</code> <code>Categorify</code><a href="https://github.com/fastai/fastai/tree/master/fastai/tabular/core.py#L237" class="source_link" style="float:right;">[source]</a></h2> <blockquote><p><code>Categorify</code>(<strong><code>enc</code></strong>=<em><code>None</code></em>, <strong><code>dec</code></strong>=<em><code>None</code></em>, <strong><code>split_idx</code></strong>=<em><code>None</code></em>, <strong><code>order</code></strong>=<em><code>None</code></em>) :: <a href="https://docs.fast.ai/tabular.core#TabularProc" target="_blank" rel="noopener noreferrer"><code>TabularProc</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>Transform the categorical variables to something similar to <code>pd.Categorical</code></p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">Categorify</span><span class="token punctuation">(</span>TabularProc<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">&quot;Transform the categorical variables to something similar to `pd.Categorical`&quot;</span>
    order <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> classes<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> classes <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span> classes <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span>L<span class="token punctuation">)</span>
        store_attr<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">setups</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> n <span class="token keyword">in</span> to<span class="token punctuation">.</span>cat_names<span class="token punctuation">:</span>
            <span class="token keyword">if</span> n <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>classes <span class="token keyword">or</span> is_categorical_dtype<span class="token punctuation">(</span>to<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>classes<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> CategoryMap<span class="token punctuation">(</span>to<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>items<span class="token punctuation">,</span> add_na<span class="token operator">=</span>n<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">encodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">:</span> to<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>to<span class="token punctuation">.</span>cat_names<span class="token punctuation">,</span> partial<span class="token punctuation">(</span>_apply_cats<span class="token punctuation">,</span> self<span class="token punctuation">.</span>classes<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">decodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">:</span> to<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>to<span class="token punctuation">.</span>cat_names<span class="token punctuation">,</span> partial<span class="token punctuation">(</span>_decode_cats<span class="token punctuation">,</span> self<span class="token punctuation">.</span>classes<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>k<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> self<span class="token punctuation">.</span>classes<span class="token punctuation">[</span>k<span class="token punctuation">]</span>
</code></pre></div><p>Now we have successfully set up our <a href="/walkwithfastai.github.io/tab.stats.html#Categorify"><code>Categorify</code></a>. Let's look at a quick example below.</p> <p>We'll make a <code>DataFrame</code> with two category columns:</p> <div class="language-python extra-class"><pre class="language-python"><code>df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div><style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&lt;!--beforebegin--&gt;&lt;div class=&quot;language- extra-class&quot;&gt;&lt;!--afterbegin--&gt;&lt;pre&gt;&lt;code&gt;.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;!--beforeend--&gt;&lt;/div&gt;&lt;!--afterend--&gt;</style> <table border="1" class="dataframe"><thead><tr style="text-align:right;"><th></th> <th>a</th> <th>b</th></tr></thead> <tbody><tr><th>0</th> <td>0</td> <td>a</td></tr> <tr><th>1</th> <td>1</td> <td>b</td></tr> <tr><th>2</th> <td>2</td> <td>a</td></tr> <tr><th>3</th> <td>0</td> <td>c</td></tr> <tr><th>4</th> <td>2</td> <td>b</td></tr></tbody></table></div> <p>Next we want to specify specific classes for <code>a</code>. We'll set a maximum range up to <code>4</code> rather than <code>2</code> shown in our <code>DataFrame</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code>tst_classes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">:</span>L<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'#na#'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span> tst_classes
</code></pre></div><div class="language- extra-class"><pre><code>{'a': (#6) ['#na#',0,1,2,3,4]}
</code></pre></div><p>Finally we will build a <a href="https://docs.fast.ai/tabular.core#TabularPandas" target="_blank" rel="noopener noreferrer"><code>TabularPandas</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> object with a modified version of <a href="/walkwithfastai.github.io/tab.stats.html#Categorify"><code>Categorify</code></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>to <span class="token operator">=</span> TabularPandas<span class="token punctuation">(</span>df<span class="token punctuation">,</span> Categorify<span class="token punctuation">(</span>classes<span class="token operator">=</span>tst_classes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>How do we tell it worked though? Let's check out <code>to.classes</code>, which is a shortcut for <code>to.procs.categorify.classes</code>.</p> <p>What we should see is our dictionary we mapped for <code>a</code>, which we do!</p> <div class="language-python extra-class"><pre class="language-python"><code>to<span class="token punctuation">.</span>classes
</code></pre></div><div class="language- extra-class"><pre><code>{'a': (#6) ['#na#',0,1,2,3,4], 'b': ['#na#', 'a', 'b', 'c']}
</code></pre></div><h3 id="normalize"><a href="#normalize" class="header-anchor">#</a> Normalize</h3> <p>Next let's move onto <a href="https://docs.fast.ai/data.transforms#Normalize" target="_blank" rel="noopener noreferrer"><code>Normalize</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Things get a bit tricky here because we also need to update the base <a href="https://docs.fast.ai/data.transforms#Normalize" target="_blank" rel="noopener noreferrer"><code>Normalize</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> transform as well.</p> <p>Why?</p> <p>Currently <code>fastai</code>'s <a href="https://docs.fast.ai/data.transforms#Normalize" target="_blank" rel="noopener noreferrer"><code>Normalize</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> tabular proc overrides the <a href="/walkwithfastai.github.io/tab.stats.html#setups"><code>setups</code></a> for <a href="https://docs.fast.ai/data.transforms#Normalize" target="_blank" rel="noopener noreferrer"><code>Normalize</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> by storing away our <code>means</code> and <code>stds</code>. What we need to do is have an option to pass in our <code>means</code> and <code>stds</code> in the base <a href="https://docs.fast.ai/data.transforms#Normalize" target="_blank" rel="noopener noreferrer"><code>Normalize</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>Let's do so here with <code>@patch</code></p> <h4 id="Normalize.__init__" class="doc_header"><code>Normalize.__init__</code><a href="https://github.com/walkwithfastai/walkwithfastai.github.io/tree/master/wwf/tab/stats.py#L29" class="source_link" style="float:right;">[source]</a></h4> <blockquote><p><code>Normalize.<strong>init</strong></code>(<strong><code>x</code></strong>:<a href="https://docs.fast.ai/data.transforms#Normalize" target="_blank" rel="noopener noreferrer"><code>Normalize</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <strong><code>mean</code></strong>=<em><code>None</code></em>, <strong><code>std</code></strong>=<em><code>None</code></em>, <strong><code>axes</code></strong>=<em><code>(0, 2, 3)</code></em>, <strong><code>means</code></strong>=<em><code>None</code></em>, <strong><code>stds</code></strong>=<em><code>None</code></em>)</p></blockquote> <p>Initialize self.  See help(type(self)) for accurate signature.</p> <p>Very nice little one-liner.</p> <p>Integrating with tabular though will not be so nice as a one-liner. Our user scenario looks something like so:</p> <p>We can pass in custom means <em>or</em> custom standard deviations, and these should be in the form of a dictionary similar to how we had our <code>classes</code> earlier. Let's modify <a href="/walkwithfastai.github.io/tab.stats.html#setups"><code>setups</code></a> to account for this:</p> <h4 id="setups" class="doc_header"><code>setups</code><a href="https://github.com/fastai/fastai/tree/master/fastai/tabular/core.py#L371" class="source_link" style="float:right;">[source]</a></h4> <blockquote><p><code>setups</code>(<strong><code>to</code></strong>:<a href="https://docs.fast.ai/tabular.core#Tabular" target="_blank" rel="noopener noreferrer"><code>Tabular</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)</p></blockquote> <p>How do we test this?</p> <p>We'll do a similar scenario to our <a href="/walkwithfastai.github.io/tab.stats.html#Categorify"><code>Categorify</code></a> example earlier. We'll have one column:</p> <div class="language-python extra-class"><pre class="language-python"><code>df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div><style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&lt;!--beforebegin--&gt;&lt;div class=&quot;language- extra-class&quot;&gt;&lt;!--afterbegin--&gt;&lt;pre&gt;&lt;code&gt;.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;!--beforeend--&gt;&lt;/div&gt;&lt;!--afterend--&gt;</style> <table border="1" class="dataframe"><thead><tr style="text-align:right;"><th></th> <th>a</th></tr></thead> <tbody><tr><th>0</th> <td>0</td></tr> <tr><th>1</th> <td>1</td></tr> <tr><th>2</th> <td>2</td></tr> <tr><th>3</th> <td>3</td></tr> <tr><th>4</th> <td>4</td></tr></tbody></table></div> <p>And normalize them with some custom statistics. In our case we'll make them <code>3</code> for a mean and <code>1</code> for the standard deviation</p> <div class="language-python extra-class"><pre class="language-python"><code>tst_means<span class="token punctuation">,</span>tst_stds <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre></div><p>We'll pass this into <a href="https://docs.fast.ai/data.transforms#Normalize" target="_blank" rel="noopener noreferrer"><code>Normalize</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and build a <a href="https://docs.fast.ai/tabular.core#TabularPandas" target="_blank" rel="noopener noreferrer"><code>TabularPandas</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> object:</p> <div class="language-python extra-class"><pre class="language-python"><code>norm <span class="token operator">=</span> Normalize<span class="token punctuation">(</span>means<span class="token operator">=</span>tst_means<span class="token punctuation">,</span> stds<span class="token operator">=</span>tst_stds<span class="token punctuation">)</span>
to <span class="token operator">=</span> TabularPandas<span class="token punctuation">(</span>df<span class="token punctuation">,</span> norm<span class="token punctuation">,</span> cont_names<span class="token operator">=</span><span class="token string">'a'</span><span class="token punctuation">)</span>
</code></pre></div><p>We can then check our <code>mean</code> and <code>std</code> values:</p> <div class="language-python extra-class"><pre class="language-python"><code>to<span class="token punctuation">.</span>means<span class="token punctuation">,</span> to<span class="token punctuation">.</span>stds
</code></pre></div><div class="language- extra-class"><pre><code>({'a': 3.0}, {'a': 1.0})
</code></pre></div><p>And they line up!</p> <h3 id="fillmissing"><a href="#fillmissing" class="header-anchor">#</a> FillMissing</h3> <p>The last preprocesser is <a href="/walkwithfastai.github.io/tab.stats.html#FillMissing"><code>FillMissing</code></a>. For this one we want to give <code>fastai</code> the ability to accept custom <code>na_dicts</code>, as this is where the information is stored on what continuous columns contains missing values!</p> <p>Compared to the last two, this integration is pretty trivial. First we'll give <code>__init__</code> the ability to accept a <code>na_dict</code>, then our <a href="/walkwithfastai.github.io/tab.stats.html#setups"><code>setups</code></a> needs to check if we have an <code>na_dict</code> already and what columns aren't there from it. First let's look at the old:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">class</span> <span class="token class-name">FillMissing</span><span class="token punctuation">(</span>TabularProc<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">&quot;Fill the missing values in continuous columns.&quot;</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> fill_strategy<span class="token operator">=</span>FillStrategy<span class="token punctuation">.</span>median<span class="token punctuation">,</span> add_col<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> fill_vals<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> fill_vals <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span> fill_vals <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">)</span>
        store_attr<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">setups</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dsets<span class="token punctuation">)</span><span class="token punctuation">:</span>
        missing <span class="token operator">=</span> pd<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span>dsets<span class="token punctuation">.</span>conts<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        store_attr<span class="token punctuation">(</span>na_dict<span class="token operator">=</span><span class="token punctuation">{</span>n<span class="token punctuation">:</span>self<span class="token punctuation">.</span>fill_strategy<span class="token punctuation">(</span>dsets<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>fill_vals<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span>
                            <span class="token keyword">for</span> n <span class="token keyword">in</span> missing<span class="token punctuation">[</span>missing<span class="token punctuation">]</span><span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fill_strategy <span class="token operator">=</span> self<span class="token punctuation">.</span>fill_strategy<span class="token punctuation">.</span>__name__

    <span class="token keyword">def</span> <span class="token function">encodes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">:</span>
        missing <span class="token operator">=</span> pd<span class="token punctuation">.</span>isnull<span class="token punctuation">(</span>to<span class="token punctuation">.</span>conts<span class="token punctuation">)</span>
        <span class="token keyword">for</span> n <span class="token keyword">in</span> missing<span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>missing<span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">assert</span> n <span class="token keyword">in</span> self<span class="token punctuation">.</span>na_dict<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f&quot;nan values in `</span><span class="token interpolation"><span class="token punctuation">{</span>n<span class="token punctuation">}</span></span><span class="token string">` but not in setup training set&quot;</span></span>
        <span class="token keyword">for</span> n <span class="token keyword">in</span> self<span class="token punctuation">.</span>na_dict<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            to<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span>self<span class="token punctuation">.</span>na_dict<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>add_col<span class="token punctuation">:</span>
                to<span class="token punctuation">.</span>loc<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span>n<span class="token operator">+</span><span class="token string">'_na'</span><span class="token punctuation">]</span> <span class="token operator">=</span> missing<span class="token punctuation">[</span>n<span class="token punctuation">]</span>
                <span class="token keyword">if</span> n<span class="token operator">+</span><span class="token string">'_na'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> to<span class="token punctuation">.</span>cat_names<span class="token punctuation">:</span> to<span class="token punctuation">.</span>cat_names<span class="token punctuation">.</span>append<span class="token punctuation">(</span>n<span class="token operator">+</span><span class="token string">'_na'</span><span class="token punctuation">)</span>
</code></pre></div><p>Followed by our new:</p> <h2 id="FillMissing" class="doc_header"><code>class</code> <code>FillMissing</code><a href="https://github.com/fastai/fastai/tree/master/fastai/tabular/core.py#L293" class="source_link" style="float:right;">[source]</a></h2> <blockquote><p><code>FillMissing</code>(<strong><code>fill_strategy</code></strong>=<em><code>median</code></em>, <strong><code>add_col</code></strong>=<em><code>True</code></em>, <strong><code>fill_vals</code></strong>=<em><code>None</code></em>) :: <a href="https://docs.fast.ai/tabular.core#TabularProc" target="_blank" rel="noopener noreferrer"><code>TabularProc</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>Fill the missing values in continuous columns.</p> <p>We can see our <a href="/walkwithfastai.github.io/tab.stats.html#setups"><code>setups</code></a> checks for what new <code>cont_names</code> we have and then updates our <code>na_dict</code> with those missing keys. Let's test it out below:</p> <div class="language-python extra-class"><pre class="language-python"><code>df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>np<span class="token punctuation">.</span>nan<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>np<span class="token punctuation">.</span>nan<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div><style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&lt;!--beforebegin--&gt;&lt;div class=&quot;language- extra-class&quot;&gt;&lt;!--afterbegin--&gt;&lt;pre&gt;&lt;code&gt;.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;!--beforeend--&gt;&lt;/div&gt;&lt;!--afterend--&gt;</style> <table border="1" class="dataframe"><thead><tr style="text-align:right;"><th></th> <th>a</th> <th>b</th></tr></thead> <tbody><tr><th>0</th> <td>0.0</td> <td>NaN</td></tr> <tr><th>1</th> <td>1.0</td> <td>1.0</td></tr> <tr><th>2</th> <td>NaN</td> <td>2.0</td></tr> <tr><th>3</th> <td>1.0</td> <td>3.0</td></tr> <tr><th>4</th> <td>2.0</td> <td>4.0</td></tr></tbody></table></div> <p>We'll pass in a dictionary for <code>a</code> but not <code>b</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code>fill <span class="token operator">=</span> FillMissing<span class="token punctuation">(</span>na_dict<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">:</span> <span class="token number">2.0</span><span class="token punctuation">}</span><span class="token punctuation">)</span> 
to <span class="token operator">=</span> TabularPandas<span class="token punctuation">(</span>df<span class="token punctuation">,</span> fill<span class="token punctuation">,</span> cont_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>And now let's look at our <code>na_dict</code>:</p> <div class="language-python extra-class"><pre class="language-python"><code>to<span class="token punctuation">.</span>na_dict
</code></pre></div><div class="language- extra-class"><pre><code>{'a': 2.0, 'b': 3.5}
</code></pre></div><p>We can see that it all works!</p> <h2 id="full-integration-example"><a href="#full-integration-example" class="header-anchor">#</a> Full Integration Example</h2> <p>Nor for those folks that don't particularly care about how we get to this point and simply want to use it, we'll do the following:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> wwf<span class="token punctuation">.</span>tab<span class="token punctuation">.</span>stats <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> fastai<span class="token punctuation">.</span>tabular<span class="token punctuation">.</span><span class="token builtin">all</span> <span class="token keyword">import</span> <span class="token operator">*</span>
</code></pre></div><p>We'll make an example from the <code>ADULT_SAMPLE</code> dataset:</p> <div class="language-python extra-class"><pre class="language-python"><code>path <span class="token operator">=</span> untar_data<span class="token punctuation">(</span>URLs<span class="token punctuation">.</span>ADULT_SAMPLE<span class="token punctuation">)</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>path<span class="token operator">/</span><span class="token string">'adult.csv'</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div><style scoped="scoped">
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
&lt;!--beforebegin--&gt;&lt;div class=&quot;language- extra-class&quot;&gt;&lt;!--afterbegin--&gt;&lt;pre&gt;&lt;code&gt;.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
&lt;/code&gt;&lt;/pre&gt;
&lt;!--beforeend--&gt;&lt;/div&gt;&lt;!--afterend--&gt;</style> <table border="1" class="dataframe"><thead><tr style="text-align:right;"><th></th> <th>age</th> <th>workclass</th> <th>fnlwgt</th> <th>education</th> <th>education-num</th> <th>marital-status</th> <th>occupation</th> <th>relationship</th> <th>race</th> <th>sex</th> <th>capital-gain</th> <th>capital-loss</th> <th>hours-per-week</th> <th>native-country</th> <th>salary</th></tr></thead> <tbody><tr><th>0</th> <td>49</td> <td>Private</td> <td>101320</td> <td>Assoc-acdm</td> <td>12.0</td> <td>Married-civ-spouse</td> <td>NaN</td> <td>Wife</td> <td>White</td> <td>Female</td> <td>0</td> <td>1902</td> <td>40</td> <td>United-States</td> <td>&gt;=50k</td></tr> <tr><th>1</th> <td>44</td> <td>Private</td> <td>236746</td> <td>Masters</td> <td>14.0</td> <td>Divorced</td> <td>Exec-managerial</td> <td>Not-in-family</td> <td>White</td> <td>Male</td> <td>10520</td> <td>0</td> <td>45</td> <td>United-States</td> <td>&gt;=50k</td></tr> <tr><th>2</th> <td>38</td> <td>Private</td> <td>96185</td> <td>HS-grad</td> <td>NaN</td> <td>Divorced</td> <td>NaN</td> <td>Unmarried</td> <td>Black</td> <td>Female</td> <td>0</td> <td>0</td> <td>32</td> <td>United-States</td> <td>&lt;50k</td></tr> <tr><th>3</th> <td>38</td> <td>Self-emp-inc</td> <td>112847</td> <td>Prof-school</td> <td>15.0</td> <td>Married-civ-spouse</td> <td>Prof-specialty</td> <td>Husband</td> <td>Asian-Pac-Islander</td> <td>Male</td> <td>0</td> <td>0</td> <td>40</td> <td>United-States</td> <td>&gt;=50k</td></tr> <tr><th>4</th> <td>42</td> <td>Self-emp-not-inc</td> <td>82297</td> <td>7th-8th</td> <td>NaN</td> <td>Married-civ-spouse</td> <td>Other-service</td> <td>Wife</td> <td>Black</td> <td>Female</td> <td>0</td> <td>0</td> <td>50</td> <td>United-States</td> <td>&lt;50k</td></tr></tbody></table></div> <p>We'll set everything up as we normally would for our <a href="https://docs.fast.ai/tabular.core#TabularPandas" target="_blank" rel="noopener noreferrer"><code>TabularPandas</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>cat_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'workclass'</span><span class="token punctuation">,</span> <span class="token string">'education'</span><span class="token punctuation">,</span> <span class="token string">'marital-status'</span><span class="token punctuation">,</span> <span class="token string">'occupation'</span><span class="token punctuation">,</span> <span class="token string">'relationship'</span><span class="token punctuation">,</span> <span class="token string">'race'</span><span class="token punctuation">]</span>
cont_names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'fnlwgt'</span><span class="token punctuation">,</span> <span class="token string">'education-num'</span><span class="token punctuation">]</span>
splits <span class="token operator">=</span> RandomSplitter<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>range_of<span class="token punctuation">(</span>df<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Except we'll define every proc ourselves. For our <a href="/walkwithfastai.github.io/tab.stats.html#Categorify"><code>Categorify</code></a> example we will use <code>relationship</code>, <a href="https://docs.fast.ai/data.transforms#Normalize" target="_blank" rel="noopener noreferrer"><code>Normalize</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> will use <code>age</code>, and <a href="/walkwithfastai.github.io/tab.stats.html#FillMissing"><code>FillMissing</code></a> will use <code>education-num</code>:</p> <h3 id="categorify-2"><a href="#categorify-2" class="header-anchor">#</a> Categorify</h3> <p>First let's find those values:</p> <div class="language-python extra-class"><pre class="language-python"><code>df<span class="token punctuation">[</span><span class="token string">'relationship'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><div class="language- extra-class"><pre><code>array([' Wife', ' Not-in-family', ' Unmarried', ' Husband', ' Own-child',
       ' Other-relative'], dtype=object)
</code></pre></div><p>And we'll set that as a dictionary with a <code>Single</code> class as well:</p> <div class="language-python extra-class"><pre class="language-python"><code>classes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'relationship'</span><span class="token punctuation">:</span> df<span class="token punctuation">[</span><span class="token string">'relationship'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>unique<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token string">' Single '</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre></div><p>And pass it to our <a href="/walkwithfastai.github.io/tab.stats.html#Categorify"><code>Categorify</code></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>cat <span class="token operator">=</span> Categorify<span class="token punctuation">(</span>classes<span class="token operator">=</span>classes<span class="token punctuation">)</span>
</code></pre></div><h3 id="normalize-2"><a href="#normalize-2" class="header-anchor">#</a> Normalize</h3> <p>Next we have normalize. We'll use a (very) wrong mean and standard deviation of 15. and 7.:</p> <div class="language-python extra-class"><pre class="language-python"><code>means<span class="token punctuation">,</span>stds <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'age'</span><span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre></div><p>And pass it to <a href="https://docs.fast.ai/data.transforms#Normalize" target="_blank" rel="noopener noreferrer"><code>Normalize</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>norm <span class="token operator">=</span> Normalize<span class="token punctuation">(</span>means<span class="token operator">=</span>means<span class="token punctuation">,</span> stds<span class="token operator">=</span>stds<span class="token punctuation">)</span>
</code></pre></div><h3 id="fillmissing-2"><a href="#fillmissing-2" class="header-anchor">#</a> FillMissing</h3> <p>Lastly we have our <a href="/walkwithfastai.github.io/tab.stats.html#FillMissing"><code>FillMissing</code></a>, which we will simply fill with 5.:</p> <div class="language-python extra-class"><pre class="language-python"><code>na_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">'education-num'</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre></div><p>And pass it in:</p> <div class="language-python extra-class"><pre class="language-python"><code>fill <span class="token operator">=</span> FillMissing<span class="token punctuation">(</span>na_dict<span class="token operator">=</span>na_dict<span class="token punctuation">)</span> 
</code></pre></div><h3 id="bringing-it-together"><a href="#bringing-it-together" class="header-anchor">#</a> Bringing it together</h3> <p>Now let's build our <a href="https://docs.fast.ai/tabular.core#TabularPandas" target="_blank" rel="noopener noreferrer"><code>TabularPandas</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> object:</p> <div class="language-python extra-class"><pre class="language-python"><code>procs <span class="token operator">=</span> <span class="token punctuation">[</span>cat<span class="token punctuation">,</span> norm<span class="token punctuation">,</span> fill<span class="token punctuation">]</span>
to <span class="token operator">=</span> TabularPandas<span class="token punctuation">(</span>df<span class="token punctuation">,</span> procs<span class="token operator">=</span>procs<span class="token punctuation">,</span> cat_names<span class="token operator">=</span>cat_names<span class="token punctuation">,</span> cont_names<span class="token operator">=</span>cont_names<span class="token punctuation">,</span>
                   y_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'salary'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> splits<span class="token operator">=</span>splits<span class="token punctuation">)</span>
</code></pre></div><p>{% include note.html content='you may need to redefine your <code>cat_names</code> and <code>cont_names</code> here, this is because <a href="/walkwithfastai.github.io/tab.stats.html#FillMissing"><code>FillMissing</code></a> may override them' %}</p> <p>And we're done!</p> <p>Thanks again for reading, and I hope this article helps you with your tabular endeavors!</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/walkwithfastai.github.io/assets/js/app.d213da4d.js" defer></script><script src="/walkwithfastai.github.io/assets/js/2.3552a41d.js" defer></script><script src="/walkwithfastai.github.io/assets/js/13.905833e1.js" defer></script>
  </body>
</html>
