<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Utilizing the timm Library Inside of fastai (Intermediate)</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Welcome to fastai">
    
    <link rel="preload" href="/walkwithfastai.github.io/assets/css/0.styles.57b101cf.css" as="style"><link rel="preload" href="/walkwithfastai.github.io/assets/js/app.d213da4d.js" as="script"><link rel="preload" href="/walkwithfastai.github.io/assets/js/2.3552a41d.js" as="script"><link rel="preload" href="/walkwithfastai.github.io/assets/js/16.60f565fe.js" as="script"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/10.1c53449a.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/11.f91edc13.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/12.c9267090.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/13.905833e1.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/14.71aae364.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/15.96fcd54f.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/17.6360a1cb.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/3.fb63bfb9.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/4.b52d6096.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/5.1a7d8c98.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/6.86aec1e1.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/7.9883384d.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/8.4b03437f.js"><link rel="prefetch" href="/walkwithfastai.github.io/assets/js/9.0fe2b969.js">
    <link rel="stylesheet" href="/walkwithfastai.github.io/assets/css/0.styles.57b101cf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/walkwithfastai.github.io/" class="home-link router-link-active"><img src="https://www.jovian.ml/fastai_logo.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/walkwithfastai.github.io/" class="nav-link">
  Overview
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Introduction" class="dropdown-title"><span class="title">Introduction</span> <span class="arrow down"></span></button> <button type="button" aria-label="Introduction" class="mobile-dropdown-title"><span class="title">Introduction</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/intro.contribute.html" class="nav-link">
  How to Contribute a Chapter
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vision" class="dropdown-title"><span class="title">Vision</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vision" class="mobile-dropdown-title"><span class="title">Vision</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/vision.intro.html" class="nav-link">
  Introduction
</a></li><li class="dropdown-item"><h4>
          Classification
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/vision.clas.single_label.html" class="nav-link">
  Single Label (Beginner)
</a></li></ul></li><li class="dropdown-item"><h4>
          External Model Integrations
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/vision.external.timm.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  timm
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tabular" class="dropdown-title"><span class="title">Tabular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tabular" class="mobile-dropdown-title"><span class="title">Tabular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/tab.clas.binary.html" class="nav-link">
  Introduction
</a></li><li class="dropdown-item"><h4>
          Classification
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/tab.clas.binary.html" class="nav-link">
  Binary (Beginner)
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/tab.cv.html" class="nav-link">
  Cross Validation (Intermediate)
</a></li></ul></div></div> <a href="https://github.com/walkwithfastai/walkwithfastai.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/walkwithfastai.github.io/" class="nav-link">
  Overview
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Introduction" class="dropdown-title"><span class="title">Introduction</span> <span class="arrow down"></span></button> <button type="button" aria-label="Introduction" class="mobile-dropdown-title"><span class="title">Introduction</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/intro.contribute.html" class="nav-link">
  How to Contribute a Chapter
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Vision" class="dropdown-title"><span class="title">Vision</span> <span class="arrow down"></span></button> <button type="button" aria-label="Vision" class="mobile-dropdown-title"><span class="title">Vision</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/vision.intro.html" class="nav-link">
  Introduction
</a></li><li class="dropdown-item"><h4>
          Classification
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/vision.clas.single_label.html" class="nav-link">
  Single Label (Beginner)
</a></li></ul></li><li class="dropdown-item"><h4>
          External Model Integrations
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/vision.external.timm.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  timm
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Tabular" class="dropdown-title"><span class="title">Tabular</span> <span class="arrow down"></span></button> <button type="button" aria-label="Tabular" class="mobile-dropdown-title"><span class="title">Tabular</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/tab.clas.binary.html" class="nav-link">
  Introduction
</a></li><li class="dropdown-item"><h4>
          Classification
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/walkwithfastai.github.io/tab.clas.binary.html" class="nav-link">
  Binary (Beginner)
</a></li></ul></li><li class="dropdown-item"><!----> <a href="/walkwithfastai.github.io/tab.cv.html" class="nav-link">
  Cross Validation (Intermediate)
</a></li></ul></div></div> <a href="https://github.com/walkwithfastai/walkwithfastai.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Utilizing the timm Library Inside of fastai (Intermediate)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/walkwithfastai.github.io/vision.external.timm.html#bringing-in-external-models-into-the-framework" class="sidebar-link">Bringing in External Models into the Framework</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/walkwithfastai.github.io/vision.external.timm.html#using-ross-wightman-s-timm-library" class="sidebar-link">Using Ross Wightman's timm Library</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/walkwithfastai.github.io/vision.external.timm.html#turning-it-all-into-a-function" class="sidebar-link">Turning it all into a function</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/walkwithfastai.github.io/vision.external.timm.html#model-lookup" class="sidebar-link">Model Lookup</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/walkwithfastai.github.io/vision.external.timm.html#listing-all-models-available" class="sidebar-link">Listing all models available</a></li><li class="sidebar-sub-header"><a href="/walkwithfastai.github.io/vision.external.timm.html#searching-for-models" class="sidebar-link">Searching for models</a></li></ul></li><li><a href="/walkwithfastai.github.io/vision.external.timm.html#some-warnings" class="sidebar-link">Some Warnings</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="utilizing-the-timm-library-inside-of-fastai-intermediate"><a href="#utilizing-the-timm-library-inside-of-fastai-intermediate" class="header-anchor">#</a> Utilizing the <code>timm</code> Library Inside of <code>fastai</code> (Intermediate)</h1> <blockquote><p>How to bring the power of Transfer Learning with new architectures</p></blockquote> <hr> <p>This article is also a Jupyter Notebook available to be run from the top down. There
will be code snippets that you can then run in any environment.</p> <p>Below are the versions of <code>fastai</code>, <code>fastcore</code>, and <code>timm</code> currently running at the time of writing this:</p> <ul><li><code>fastai</code>: 2.0.14</li> <li><code>fastcore</code>: 1.0.11</li> <li><code>timm</code>: 0.2.1</li></ul> <hr> <h2 id="bringing-in-external-models-into-the-framework"><a href="#bringing-in-external-models-into-the-framework" class="header-anchor">#</a> Bringing in External Models into the Framework</h2> <p>As we are well aware, <code>fastai</code> models deep down are just <code>PyTorch</code> models. However as the field of Machine Learning keeps going, new and fresh architectures are introduced. Wouldn't it be nice if it were easy to integrate them into the <code>fastai</code> framework and play with them?</p> <h2 id="using-ross-wightman-s-timm-library"><a href="#using-ross-wightman-s-timm-library" class="header-anchor">#</a> Using Ross Wightman's <code>timm</code> Library</h2> <p><a href="https://twitter.com/wightmanr" target="_blank" rel="noopener noreferrer">Ross Wightman<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> has been on a mission to get pretrained weights for the newest Computer Vision models that come out of papers, and compare his results what the papers state themselves. The fantastic results live in his repository <a href="https://github.com/rwightman/pytorch-image-models" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>For users of the <code>fastai</code> library, it is a goldmine of models to play with! But how do we use it? Let's set up a basic <code>PETs</code> problem following the <a href="https://walkwithfastai.com/vision.clas.single_label" target="_blank" rel="noopener noreferrer">tutorial<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</p> <div class="language-python extra-class"><pre class="language-python"><code>path <span class="token operator">=</span> untar_data<span class="token punctuation">(</span>URLs<span class="token punctuation">.</span>PETS<span class="token punctuation">)</span>
pat <span class="token operator">=</span> <span class="token string">r'/([^/]+)_\d+.*'</span>
item_tfms <span class="token operator">=</span> RandomResizedCrop<span class="token punctuation">(</span><span class="token number">460</span><span class="token punctuation">,</span> min_scale<span class="token operator">=</span><span class="token number">0.75</span><span class="token punctuation">,</span> ratio<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
batch_tfms <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">*</span>aug_transforms<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">224</span><span class="token punctuation">,</span> max_warp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Normalize<span class="token punctuation">.</span>from_stats<span class="token punctuation">(</span><span class="token operator">*</span>imagenet_stats<span class="token punctuation">)</span><span class="token punctuation">]</span>
bs<span class="token operator">=</span><span class="token number">16</span>
pets <span class="token operator">=</span> DataBlock<span class="token punctuation">(</span>blocks<span class="token operator">=</span><span class="token punctuation">(</span>ImageBlock<span class="token punctuation">,</span> CategoryBlock<span class="token punctuation">)</span><span class="token punctuation">,</span>
                 get_items<span class="token operator">=</span>get_image_files<span class="token punctuation">,</span>
                 splitter<span class="token operator">=</span>RandomSplitter<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 get_y<span class="token operator">=</span>RegexLabeller<span class="token punctuation">(</span>pat <span class="token operator">=</span> pat<span class="token punctuation">)</span><span class="token punctuation">,</span>
                 item_tfms<span class="token operator">=</span>item_tfms<span class="token punctuation">,</span>
                 batch_tfms<span class="token operator">=</span>batch_tfms<span class="token punctuation">)</span>
dls <span class="token operator">=</span> pets<span class="token punctuation">.</span>dataloaders<span class="token punctuation">(</span>path<span class="token operator">/</span><span class="token string">'images'</span><span class="token punctuation">,</span> bs<span class="token operator">=</span>bs<span class="token punctuation">)</span>
</code></pre></div><p>From here we would normally do something like <code>cnn_learner(dls, arch, metrics)</code>, however we need to do a few things special to work with Ross' framework.</p> <p><code>fastai</code> has a <a href="https://docs.fast.ai/vision.learner#create_body" target="_blank" rel="noopener noreferrer"><code>create_body</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> function, whcih is called during <a href="https://docs.fast.ai/vision.learner#cnn_learner" target="_blank" rel="noopener noreferrer"><code>cnn_learner</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, that will take a model architecuture and slice off the last Linear layer (resulting in a &quot;body&quot; that outputs unpooled features). This function looks like:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">create_body</span><span class="token punctuation">(</span>arch<span class="token punctuation">,</span> n_in<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> cut<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">&quot;Cut off the body of a typically pretrained `arch` as determined by `cut`&quot;</span>
    model <span class="token operator">=</span> arch<span class="token punctuation">(</span>pretrained<span class="token operator">=</span>pretrained<span class="token punctuation">)</span>
    _update_first_layer<span class="token punctuation">(</span>model<span class="token punctuation">,</span> n_in<span class="token punctuation">,</span> pretrained<span class="token punctuation">)</span>
    <span class="token keyword">if</span> cut <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        ll <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">enumerate</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        cut <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>i <span class="token keyword">for</span> i<span class="token punctuation">,</span>o <span class="token keyword">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>ll<span class="token punctuation">)</span> <span class="token keyword">if</span> has_pool_type<span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span>   <span class="token builtin">isinstance</span><span class="token punctuation">(</span>cut<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>      <span class="token keyword">return</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">list</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span>cut<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> <span class="token builtin">callable</span><span class="token punctuation">(</span>cut<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> cut<span class="token punctuation">(</span>model<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>                           <span class="token keyword">raise</span> NamedError<span class="token punctuation">(</span><span class="token string">&quot;cut must be either integer or a function&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>We're going to create our own that plays well</p> <blockquote><p>Also:notebooks like this are exported as external modules inside of the <code>wwf</code> library! This one can be found in <code>vision.timm</code> to be used with your projects!</p></blockquote> <h4 id="create_timm_body" class="doc_header"><code>create_timm_body</code><a href="https://github.com/walkwithfastai/walkwithfastai.github.io/tree/master/wwf/vision/timm.py#L13" class="source_link" style="float:right;">[source]</a></h4> <blockquote><p><code>create_timm_body</code>(<strong><code>arch</code></strong>:<code>str</code>, <strong><code>pretrained</code></strong>=<em><code>True</code></em>, <strong><code>cut</code></strong>=<em><code>None</code></em>, <strong><code>n_in</code></strong>=<em><code>3</code></em>)</p></blockquote> <p>Creates a body from any model in the <code>timm</code> library.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">create_timm_body</span><span class="token punctuation">(</span>arch<span class="token punctuation">:</span><span class="token builtin">str</span><span class="token punctuation">,</span> pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> cut<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> n_in<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">&quot;Creates a body from any model in the `timm` library.&quot;</span>
    model <span class="token operator">=</span> create_model<span class="token punctuation">(</span>arch<span class="token punctuation">,</span> pretrained<span class="token operator">=</span>pretrained<span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> global_pool<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
    _update_first_layer<span class="token punctuation">(</span>model<span class="token punctuation">,</span> n_in<span class="token punctuation">,</span> pretrained<span class="token punctuation">)</span>
    <span class="token keyword">if</span> cut <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        ll <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">enumerate</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        cut <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>i <span class="token keyword">for</span> i<span class="token punctuation">,</span>o <span class="token keyword">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>ll<span class="token punctuation">)</span> <span class="token keyword">if</span> has_pool_type<span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>cut<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">list</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span>cut<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> <span class="token builtin">callable</span><span class="token punctuation">(</span>cut<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">return</span> cut<span class="token punctuation">(</span>model<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token keyword">raise</span> NamedError<span class="token punctuation">(</span><span class="token string">&quot;cut must be either integer or function&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>How do we use it? Let's try it out on an <code>efficientnet_b3</code> architecture (the entire list of supported architectures is found <a href="https://github.com/rwightman/pytorch-image-models#models" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-python extra-class"><pre class="language-python"><code>body <span class="token operator">=</span> create_timm_body<span class="token punctuation">(</span><span class="token string">'efficientnet_b3a'</span><span class="token punctuation">,</span> pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</code></pre></div><p>From here we can calculate the number input features our head needs to have with <a href="https://docs.fast.ai/callback.hook#num_features_model" target="_blank" rel="noopener noreferrer"><code>num_features_model</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.  We'll mutliply this by two since we have two pooling layers, <a href="https://docs.fast.ai/layers#AdaptiveConcatPool2d" target="_blank" rel="noopener noreferrer"><code>AdaptiveConcatPool2d</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and <code>nn.AdaptiveAvgPool2d</code></p> <div class="language-python extra-class"><pre class="language-python"><code>nf <span class="token operator">=</span> num_features_model<span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span> nf
</code></pre></div><div class="language- extra-class"><pre><code>3072
</code></pre></div><p>And now we can create a head!</p> <div class="language-python extra-class"><pre class="language-python"><code>head <span class="token operator">=</span> create_head<span class="token punctuation">(</span>nf<span class="token punctuation">,</span> dls<span class="token punctuation">.</span>c<span class="token punctuation">)</span>
</code></pre></div><p>To mix them together, we just wrap the two in a <code>nn.Sequential</code> and we now have a <code>PyTorch</code> model ready to be trained on:</p> <div class="language-python extra-class"><pre class="language-python"><code>net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>body<span class="token punctuation">,</span> head<span class="token punctuation">)</span>
</code></pre></div><p>From here we would pass it onto <a href="https://docs.fast.ai/learner#Learner" target="_blank" rel="noopener noreferrer"><code>Learner</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, specifying our <code>splitter</code> to be the <a href="https://docs.fast.ai/vision.learner#default_split" target="_blank" rel="noopener noreferrer"><code>default_split</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p><code>default_splitter</code> expects the body in <code>model[0]</code> and the head in <code>model[1]</code> to split our layer groups</p></blockquote> <div class="language-python extra-class"><pre class="language-python"><code>learn <span class="token operator">=</span> Learner<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> net<span class="token punctuation">,</span> splitter<span class="token operator">=</span>default_split<span class="token punctuation">)</span>
</code></pre></div><p>To know this all worked properly, we should be able to call <code>learn.freeze()</code> and check the number of frozen parameters. (You can also call <code>learn.summary</code> but we are not since it has a lengthy output):</p> <div class="language-python extra-class"><pre class="language-python"><code>learn<span class="token punctuation">.</span>freeze<span class="token punctuation">(</span><span class="token punctuation">)</span>
unfrozen_params <span class="token operator">=</span> <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> p<span class="token punctuation">:</span> <span class="token keyword">not</span> p<span class="token punctuation">.</span>requires_grad<span class="token punctuation">,</span> learn<span class="token punctuation">.</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
unfrozen_params <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>prod<span class="token punctuation">(</span>p<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> p <span class="token keyword">in</span> unfrozen_params<span class="token punctuation">]</span><span class="token punctuation">)</span>
model_parameters <span class="token operator">=</span> <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> p<span class="token punctuation">:</span> p<span class="token punctuation">.</span>requires_grad<span class="token punctuation">,</span> learn<span class="token punctuation">.</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
frozen_params <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>prod<span class="token punctuation">(</span>p<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> p <span class="token keyword">in</span> model_parameters<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>unfrozen_params<span class="token punctuation">,</span> frozen_params
</code></pre></div><div class="language- extra-class"><pre><code>(1686272, 10608936)
</code></pre></div><p>Which we can see that only 1.6 million of the 10 million parameters are trainable, so our model is ready for transfer learning!</p> <h2 id="turning-it-all-into-a-function"><a href="#turning-it-all-into-a-function" class="header-anchor">#</a> Turning it all into a function</h2> <p>Let's make this a bit easier and create something like <a href="https://docs.fast.ai/vision.learner#cnn_learner" target="_blank" rel="noopener noreferrer"><code>cnn_learner</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, but for <code>timm</code>! We'll call it a <a href="/walkwithfastai.github.io/vision.external.timm.html#timm_learner"><code>timm_learner</code></a>. First let's look at and compare what <a href="https://docs.fast.ai/vision.learner#cnn_learner" target="_blank" rel="noopener noreferrer"><code>cnn_learner</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> does internally:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">cnn_learner</span><span class="token punctuation">(</span>dls<span class="token punctuation">,</span> arch<span class="token punctuation">,</span> loss_func<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> cut<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> splitter<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                y_range<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> config<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> n_out<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> normalize<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">&quot;Build a convnet style learner from `dls` and `arch`&quot;</span>
    <span class="token keyword">if</span> config <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span> config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    meta <span class="token operator">=</span> model_meta<span class="token punctuation">.</span>get<span class="token punctuation">(</span>arch<span class="token punctuation">,</span> _default_meta<span class="token punctuation">)</span>
    <span class="token keyword">if</span> n_out <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span> n_out <span class="token operator">=</span> get_c<span class="token punctuation">(</span>dls<span class="token punctuation">)</span>
    <span class="token keyword">assert</span> n_out<span class="token punctuation">,</span> <span class="token string">&quot;`n_out` is not defined, and could not be inferred from data, set `dls.c` or pass `n_out`&quot;</span>
    <span class="token keyword">if</span> normalize<span class="token punctuation">:</span> _add_norm<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> meta<span class="token punctuation">,</span> pretrained<span class="token punctuation">)</span>
    <span class="token keyword">if</span> y_range <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">and</span> <span class="token string">'y_range'</span> <span class="token keyword">in</span> config<span class="token punctuation">:</span> y_range <span class="token operator">=</span> config<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'y_range'</span><span class="token punctuation">)</span>
    model <span class="token operator">=</span> create_cnn_model<span class="token punctuation">(</span>arch<span class="token punctuation">,</span> n_out<span class="token punctuation">,</span> ifnone<span class="token punctuation">(</span>cut<span class="token punctuation">,</span> meta<span class="token punctuation">[</span><span class="token string">'cut'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pretrained<span class="token punctuation">,</span> y_range<span class="token operator">=</span>y_range<span class="token punctuation">,</span> <span class="token operator">**</span>config<span class="token punctuation">)</span>
    learn <span class="token operator">=</span> Learner<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> model<span class="token punctuation">,</span> loss_func<span class="token operator">=</span>loss_func<span class="token punctuation">,</span> splitter<span class="token operator">=</span>ifnone<span class="token punctuation">(</span>splitter<span class="token punctuation">,</span> meta<span class="token punctuation">[</span><span class="token string">'split'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    <span class="token keyword">if</span> pretrained<span class="token punctuation">:</span> learn<span class="token punctuation">.</span>freeze<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> learn
</code></pre></div><p>At first it looks scary, but let's try and read it as best we can:</p> <ol><li>Grab potential private meta about an architecture we're using</li> <li>Grab the number of expected outputs</li> <li>Potentially normalize</li> <li>Add a <code>y_range</code></li> <li>Create a <code>cnn_model</code> and <a href="https://docs.fast.ai/learner#Learner" target="_blank" rel="noopener noreferrer"><code>Learner</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>Freeze our model</li></ol> <p>We're going to make a custom <a href="/walkwithfastai.github.io/vision.external.timm.html#create_timm_model"><code>create_timm_model</code></a> and <a href="/walkwithfastai.github.io/vision.external.timm.html#timm_learner"><code>timm_learner</code></a> function to do what we just did above. First, <a href="/walkwithfastai.github.io/vision.external.timm.html#create_timm_model"><code>create_timm_model</code></a> will model after <a href="https://docs.fast.ai/vision.learner#create_cnn_model" target="_blank" rel="noopener noreferrer"><code>create_cnn_model</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>:</p> <h4 id="create_timm_model" class="doc_header"><code>create_timm_model</code><a href="https://github.com/walkwithfastai/walkwithfastai.github.io/tree/master/wwf/vision/timm.py#L25" class="source_link" style="float:right;">[source]</a></h4> <blockquote><p><code>create_timm_model</code>(<strong><code>arch</code></strong>:<code>str</code>, <strong><code>n_out</code></strong>, <strong><code>cut</code></strong>=<em><code>None</code></em>, <strong><code>pretrained</code></strong>=<em><code>True</code></em>, <strong><code>n_in</code></strong>=<em><code>3</code></em>, <strong><code>init</code></strong>=<em><code>kaiming_normal_</code></em>, <strong><code>custom_head</code></strong>=<em><code>None</code></em>, <strong><code>concat_pool</code></strong>=<em><code>True</code></em>, <strong>**<code>kwargs</code></strong>)</p></blockquote> <p>Create custom architecture using <code>arch</code>, <code>n_in</code> and <code>n_out</code> from the <code>timm</code> library</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">create_timm_model</span><span class="token punctuation">(</span>arch<span class="token punctuation">:</span><span class="token builtin">str</span><span class="token punctuation">,</span> n_out<span class="token punctuation">,</span> cut<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> n_in<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> init<span class="token operator">=</span>nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>kaiming_normal_<span class="token punctuation">,</span> custom_head<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                     concat_pool<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">&quot;Create custom architecture using `arch`, `n_in` and `n_out` from the `timm` library&quot;</span>
    body <span class="token operator">=</span> create_timm_body<span class="token punctuation">(</span>arch<span class="token punctuation">,</span> pretrained<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> n_in<span class="token punctuation">)</span>
    <span class="token keyword">if</span> custom_head <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        nf <span class="token operator">=</span> num_features_model<span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span>body<span class="token punctuation">.</span>children<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token keyword">if</span> concat_pool <span class="token keyword">else</span> <span class="token number">1</span><span class="token punctuation">)</span>
        head <span class="token operator">=</span> create_head<span class="token punctuation">(</span>nf<span class="token punctuation">,</span> n_out<span class="token punctuation">,</span> concat_pool<span class="token operator">=</span>concat_pool<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span> head <span class="token operator">=</span> custom_head
    model <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>body<span class="token punctuation">,</span> head<span class="token punctuation">)</span>
    <span class="token keyword">if</span> init <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span> apply_init<span class="token punctuation">(</span>model<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> init<span class="token punctuation">)</span>
    <span class="token keyword">return</span> model
</code></pre></div><p>And now for our <a href="/walkwithfastai.github.io/vision.external.timm.html#timm_learner"><code>timm_learner</code></a>:</p> <h4 id="timm_learner" class="doc_header"><code>timm_learner</code><a href="https://github.com/walkwithfastai/walkwithfastai.github.io/tree/master/wwf/vision/timm.py#L41" class="source_link" style="float:right;">[source]</a></h4> <blockquote><p><code>timm_learner</code>(<strong><code>dls</code></strong>, <strong><code>arch</code></strong>:<code>str</code>, <strong><code>loss_func</code></strong>=<em><code>None</code></em>, <strong><code>pretrained</code></strong>=<em><code>True</code></em>, <strong><code>cut</code></strong>=<em><code>None</code></em>, <strong><code>splitter</code></strong>=<em><code>None</code></em>, <strong><code>y_range</code></strong>=<em><code>None</code></em>, <strong><code>config</code></strong>=<em><code>None</code></em>, <strong><code>n_out</code></strong>=<em><code>None</code></em>, <strong><code>normalize</code></strong>=<em><code>True</code></em>, <strong>**<code>kwargs</code></strong>)</p></blockquote> <p>Build a convnet style learner from <code>dls</code> and <code>arch</code> using the <code>timm</code> library</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">def</span> <span class="token function">timm_learner</span><span class="token punctuation">(</span>dls<span class="token punctuation">,</span> arch<span class="token punctuation">:</span><span class="token builtin">str</span><span class="token punctuation">,</span> loss_func<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> cut<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> splitter<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
                y_range<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> config<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> n_out<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> normalize<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token string">&quot;Build a convnet style learner from `dls` and `arch` using the `timm` library&quot;</span>
    <span class="token keyword">if</span> config <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span> config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">if</span> n_out <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span> n_out <span class="token operator">=</span> get_c<span class="token punctuation">(</span>dls<span class="token punctuation">)</span>
    <span class="token keyword">assert</span> n_out<span class="token punctuation">,</span> <span class="token string">&quot;`n_out` is not defined, and could not be inferred from data, set `dls.c` or pass `n_out`&quot;</span>
    <span class="token keyword">if</span> y_range <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">and</span> <span class="token string">'y_range'</span> <span class="token keyword">in</span> config<span class="token punctuation">:</span> y_range <span class="token operator">=</span> config<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">'y_range'</span><span class="token punctuation">)</span>
    model <span class="token operator">=</span> create_timm_model<span class="token punctuation">(</span>arch<span class="token punctuation">,</span> n_out<span class="token punctuation">,</span> default_split<span class="token punctuation">,</span> pretrained<span class="token punctuation">,</span> y_range<span class="token operator">=</span>y_range<span class="token punctuation">,</span> <span class="token operator">**</span>config<span class="token punctuation">)</span>
    learn <span class="token operator">=</span> Learner<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> model<span class="token punctuation">,</span> loss_func<span class="token operator">=</span>loss_func<span class="token punctuation">,</span> splitter<span class="token operator">=</span>default_split<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
    <span class="token keyword">if</span> pretrained<span class="token punctuation">:</span> learn<span class="token punctuation">.</span>freeze<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> learn
</code></pre></div><p>Let's try it out by making the same model we did a moment ago:</p> <div class="language-python extra-class"><pre class="language-python"><code>learn <span class="token operator">=</span> timm_learner<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> <span class="token string">'efficientnet_b3a'</span><span class="token punctuation">)</span>
</code></pre></div><p>And to verify let's look at those parameters one more time:</p> <div class="language-python extra-class"><pre class="language-python"><code>unfrozen_params <span class="token operator">=</span> <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> p<span class="token punctuation">:</span> <span class="token keyword">not</span> p<span class="token punctuation">.</span>requires_grad<span class="token punctuation">,</span> learn<span class="token punctuation">.</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
unfrozen_params <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>prod<span class="token punctuation">(</span>p<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> p <span class="token keyword">in</span> unfrozen_params<span class="token punctuation">]</span><span class="token punctuation">)</span>
model_parameters <span class="token operator">=</span> <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> p<span class="token punctuation">:</span> p<span class="token punctuation">.</span>requires_grad<span class="token punctuation">,</span> learn<span class="token punctuation">.</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
frozen_params <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>prod<span class="token punctuation">(</span>p<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> p <span class="token keyword">in</span> model_parameters<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>unfrozen_params<span class="token punctuation">,</span> frozen_params
</code></pre></div><div class="language- extra-class"><pre><code>(1686272, 10608936)
</code></pre></div><p>They're exactly the same! So now we can utilize any architecture found inside of <code>timm</code> right away, and we built it in a structure very similar to how native <code>fastai</code> does it.</p> <p>To use this module in your own work, simply do:</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">from</span> wwf<span class="token punctuation">.</span>vision<span class="token punctuation">.</span>timm <span class="token keyword">import</span> <span class="token operator">*</span>
learn <span class="token operator">=</span> timm_learner<span class="token punctuation">(</span>dls<span class="token punctuation">,</span> <span class="token string">'efficientnet_b3a'</span><span class="token punctuation">,</span> metrics<span class="token operator">=</span><span class="token punctuation">[</span>error_rate<span class="token punctuation">,</span> accuracy<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>{% include note.html content='<code>timm</code> needs to be installed beforehand' %}</p> <h2 id="model-lookup"><a href="#model-lookup" class="header-anchor">#</a> Model Lookup</h2> <p>To query various models to see what is available, you should directly use the <code>timm</code> library.</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> timm
</code></pre></div><h3 id="listing-all-models-available"><a href="#listing-all-models-available" class="header-anchor">#</a> Listing all models available</h3> <p>One option is to list every model possible:</p> <div class="language-python extra-class"><pre class="language-python"><code>timm<span class="token punctuation">.</span>list_models<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>
</code></pre></div><div class="language- extra-class"><pre><code>['adv_inception_v3',
 'cspdarknet53',
 'cspdarknet53_iabn',
 'cspresnet50',
 'cspresnet50d',
 'cspresnet50w',
 'cspresnext50',
 'cspresnext50_iabn',
 'darknet53',
 'densenet121']
</code></pre></div><h3 id="searching-for-models"><a href="#searching-for-models" class="header-anchor">#</a> Searching for models</h3> <p>You can also query the names of what is available as well, denoted as below:</p> <div class="language-python extra-class"><pre class="language-python"><code>timm<span class="token punctuation">.</span>list_models<span class="token punctuation">(</span><span class="token string">'*efficientnet*'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>
</code></pre></div><div class="language- extra-class"><pre><code>['efficientnet_b0',
 'efficientnet_b1',
 'efficientnet_b1_pruned',
 'efficientnet_b2',
 'efficientnet_b2_pruned',
 'efficientnet_b2a',
 'efficientnet_b3',
 'efficientnet_b3_pruned',
 'efficientnet_b3a',
 'efficientnet_b4']
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>timm<span class="token punctuation">.</span>list_models<span class="token punctuation">(</span><span class="token string">'*b3a'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>
</code></pre></div><div class="language- extra-class"><pre><code>['efficientnet_b3a']
</code></pre></div><div class="language-python extra-class"><pre class="language-python"><code>timm<span class="token punctuation">.</span>list_models<span class="token punctuation">(</span><span class="token string">'resne*t*'</span><span class="token punctuation">,</span> pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span>
</code></pre></div><div class="language- extra-class"><pre><code>['resnest14d',
 'resnest26d',
 'resnest50d',
 'resnest50d_1s4x24d',
 'resnest50d_4s2x40d',
 'resnest101e',
 'resnest200e',
 'resnest269e',
 'resnet18',
 'resnet26']
</code></pre></div><h2 id="some-warnings"><a href="#some-warnings" class="header-anchor">#</a> Some Warnings</h2> <ul><li><p>Watch for anything with a <code>tf_</code> prefix. This means the original weights were ported from Google, so it uses manual padding to match TensorFlow's &quot;same&quot; padding, which adds GPU overhead and a general slowdown. If possible try to use the non-TF versions of models</p></li> <li><p>HRNet is a bit of a problem-child, so it is the only one not straight-forward to use</p></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/walkwithfastai.github.io/assets/js/app.d213da4d.js" defer></script><script src="/walkwithfastai.github.io/assets/js/2.3552a41d.js" defer></script><script src="/walkwithfastai.github.io/assets/js/16.60f565fe.js" defer></script>
  </body>
</html>
